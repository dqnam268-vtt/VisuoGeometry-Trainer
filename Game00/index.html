<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Shooter - Click to Start</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
    <script crossorigin="anonymous" src="https://unpkg.com/@mediapipe/hands@0.4.1646424915/hands.js"></script>
    <script crossorigin="anonymous" src="https://unpkg.com/@mediapipe/drawing_utils@0.3/drawing_utils.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: monospace; }
        /* Video ẩn đi nhưng vẫn render để AI đọc */
        #input-video {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; transform: scaleX(-1); z-index: 0;
            opacity: 0.5; /* Để mờ để thấy video nền */
        }
        #output-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none;
        }
        #ui-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 20;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        // --- AUDIO ---
        const playSound = (type) => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            
            if (type === 'shoot') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(100, now + 0.15);
                gain.gain.setValueAtTime(0.3, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                osc.start(now); osc.stop(now + 0.15);
            }
        };

        function App() {
            // UI States
            const [hasStarted, setHasStarted] = useState(false); // Quan trọng: Chờ người dùng bấm
            const [status, setStatus] = useState("WAITING"); // WAITING -> LOADING -> READY
            const [errorMsg, setErrorMsg] = useState(null);

            const videoRef = useRef(null);
            const containerRef = useRef(null);
            const handsRef = useRef(null);
            
            // Game Loop Refs
            const gameLogic = useRef({
                scene: null, camera: null, renderer: null,
                crosshair: null, laser: null,
                particles: [],
                rawFinger: new THREE.Vector3(),
                isPinching: false, wasPinching: false,
                handDetected: false
            });

            // 1. SETUP THREEJS (Chạy 1 lần)
            useEffect(() => {
                if(!containerRef.current) return;
                
                const width = window.innerWidth;
                const height = window.innerHeight;
                
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, width/height, 0.1, 100);
                camera.position.z = 5;

                const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
                renderer.setSize(width, height);
                renderer.domElement.id = "output-canvas";
                containerRef.current.appendChild(renderer.domElement);

                // Add Objects
                const ring = new THREE.Mesh(
                    new THREE.RingGeometry(0.15, 0.2, 32),
                    new THREE.MeshBasicMaterial({ color: 0x00ffcc, transparent: true, opacity: 0.8 })
                );
                scene.add(ring);

                const laser = new THREE.Line(
                    new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(), new THREE.Vector3(0,0,-10)]),
                    new THREE.LineBasicMaterial({ color: 0xff00ff })
                );
                scene.add(laser);

                gameLogic.current.scene = scene;
                gameLogic.current.camera = camera;
                gameLogic.current.renderer = renderer;
                gameLogic.current.crosshair = ring;
                gameLogic.current.laser = laser;

                // Render Loop
                const animate = () => {
                    requestAnimationFrame(animate);
                    updateGame();
                    renderer.render(scene, camera);
                };
                animate();

            }, []);

            // 2. KÍCH HOẠT CAMERA (Chỉ chạy khi bấm nút)
            const startGame = async () => {
                try {
                    setHasStarted(true);
                    setStatus("LOADING CAMERA...");
                    
                    if (!videoRef.current) throw new Error("Lỗi Video Element bị Null");
                    if (!window.Hands) throw new Error("Chưa tải xong thư viện AI");

                    const video = videoRef.current;

                    // Xin quyền Camera
                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: false,
                        video: true // Tự động chọn cam phù hợp
                    });

                    video.srcObject = stream;
                    await video.play();

                    setStatus("AI STARTING...");

                    // Setup MediaPipe
                    const hands = new window.Hands({locateFile: (file) => 
                        `https://unpkg.com/@mediapipe/hands@0.4.1646424915/${file}`
                    });
                    
                    hands.setOptions({
                        maxNumHands: 1,
                        modelComplexity: 0,
                        minDetectionConfidence: 0.5,
                        minTrackingConfidence: 0.5
                    });

                    hands.onResults((results) => {
                        const game = gameLogic.current;
                        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                            game.handDetected = true;
                            const lm = results.multiHandLandmarks[0];
                            
                            // Map coordinates
                            // Index Tip (8)
                            const x = (1 - lm[8].x) * 10 - 5;
                            const y = (1 - lm[8].y) * 8 - 4;
                            game.rawFinger.set(x, y, 0);

                            // Pinch (4 & 8)
                            const dist = Math.sqrt(Math.pow(lm[4].x - lm[8].x, 2) + Math.pow(lm[4].y - lm[8].y, 2));
                            game.isPinching = dist < 0.06;
                        } else {
                            game.handDetected = false;
                        }
                    });

                    // Loop AI
                    const detect = async () => {
                        if (video.readyState >= 2) await hands.send({image: video});
                        setTimeout(detect, 60); // ~15FPS
                    };
                    detect();

                    setStatus("READY");

                } catch (e) {
                    setErrorMsg(e.message);
                }
            };

            const updateGame = () => {
                const game = gameLogic.current;
                if (!game.scene) return;

                if (game.handDetected) {
                    // Smooth move
                    game.crosshair.position.lerp(game.rawFinger, 0.2);
                    
                    // Laser
                    const pos = game.laser.geometry.attributes.position.array;
                    pos[3] = game.crosshair.position.x;
                    pos[4] = game.crosshair.position.y;
                    game.laser.geometry.attributes.position.needsUpdate = true;

                    // Shoot
                    if (game.isPinching) {
                        game.crosshair.material.color.setHex(0xff0000);
                        game.crosshair.scale.setScalar(0.8);
                        if (!game.wasPinching) {
                            playSound('shoot');
                            // Add particle effect logic here if needed
                        }
                    } else {
                        game.crosshair.material.color.setHex(0x00ffcc);
                        game.crosshair.scale.setScalar(1);
                    }
                    game.wasPinching = game.isPinching;
                }
            };

            return (
                <div className="w-full h-full bg-black relative">
                    {/* VIDEO NẰM TRONG REACT ĐỂ TRÁNH NULL */}
                    <video 
                        ref={videoRef} 
                        playsInline 
                        muted 
                        id="input-video"
                    ></video>
                    
                    {/* CANVAS CONTAINER */}
                    <div ref={containerRef} className="absolute inset-0 pointer-events-none z-10"></div>

                    {/* UI LỚP TRÊN CÙNG */}
                    <div className="absolute inset-0 z-50 flex flex-col items-center justify-center pointer-events-none">
                        
                        {/* MÀN HÌNH CHỜ (QUAN TRỌNG) */}
                        {!hasStarted && !errorMsg && (
                            <div className="bg-black/80 p-8 rounded-2xl border-2 border-cyan-500 text-center pointer-events-auto shadow-[0_0_50px_#0ff]">
                                <h1 className="text-4xl font-black text-cyan-400 mb-4 drop-shadow-lg">AR SHOOTER</h1>
                                <p className="text-white mb-6">Yêu cầu quyền Camera</p>
                                <button 
                                    onClick={startGame}
                                    className="px-8 py-4 bg-cyan-500 hover:bg-cyan-400 text-black font-bold text-xl rounded-full transition-all active:scale-95"
                                >
                                    BẤM ĐỂ CHƠI 
                                </button>
                                <p className="text-gray-500 text-xs mt-4">Vui lòng cho phép Camera khi được hỏi</p>
                            </div>
                        )}

                        {/* TRẠNG THÁI LOADING */}
                        {hasStarted && status !== "READY" && !errorMsg && (
                            <div className="text-cyan-400 font-mono text-xl animate-pulse">
                                {status}
                            </div>
                        )}

                        {/* HỘP THÔNG BÁO LỖI */}
                        {errorMsg && (
                            <div className="bg-red-900/90 p-6 rounded-lg text-white text-center max-w-sm pointer-events-auto border border-red-500">
                                <div className="text-3xl mb-2">⚠️</div>
                                <h3 className="font-bold text-lg mb-2">LỖI HỆ THỐNG</h3>
                                <p className="font-mono text-sm mb-4 break-words">{errorMsg}</p>
                                <button 
                                    onClick={() => window.location.reload()}
                                    className="bg-white text-red-900 px-4 py-2 rounded font-bold hover:bg-gray-200"
                                >
                                    TẢI LẠI TRANG
                                </button>
                            </div>
                        )}
                        
                        {/* HUD KHI CHƠI */}
                        {status === "READY" && (
                            <div className="absolute top-4 left-4 text-cyan-400 font-mono font-bold pointer-events-none">
                                SYSTEM: ONLINE<br/>
                                HAND: {gameLogic.current.handDetected ? "DETECTED" : "SEARCHING..."}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>