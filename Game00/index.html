<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Thi√™n C∆° B·∫£ng - Tu Ti√™n (Mouse/Cam)</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script crossorigin="anonymous" src="https://unpkg.com/@mediapipe/hands@0.4.1675469240/hands.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Noto+Serif+SC:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Noto Serif SC', serif; user-select: none; }
        
        #input-video {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; transform: scaleX(-1); z-index: 0;
            opacity: 0.3; mix-blend-mode: screen; filter: contrast(1.2) sepia(0.3) hue-rotate(240deg);
        }

        /* Theme Tu Ti√™n */
        .glass-panel {
            background: rgba(20, 10, 40, 0.85);
            box-shadow: 0 0 15px rgba(138, 43, 226, 0.5), inset 0 0 20px rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(255, 215, 0, 0.4);
            border-radius: 12px;
            backdrop-filter: blur(8px);
        }

        .title-font { font-family: 'Cinzel Decorative', cursive; letter-spacing: 2px; text-shadow: 0 0 10px #d4af37; }

        /* Con tr·ªè Linh H·ªìn */
        .spirit-cursor {
            position: fixed; pointer-events: none; z-index: 9999;
            width: 0; height: 0;
            transition: transform 0.1s ease-out; /* M∆∞·ª£t h∆°n cho chu·ªôt */
        }
        .spirit-cursor-core {
            position: absolute; top: -10px; left: -10px; width: 20px; height: 20px;
            background: #00ffff;
            box-shadow: 0 0 20px 10px rgba(0, 255, 255, 0.6);
            border-radius: 50%;
        }
        .spirit-cursor-ring {
            position: absolute; top: -25px; left: -25px; width: 50px; height: 50px;
            border: 1px dashed gold; border-radius: 50%;
            animation: spinTarget 3s linear infinite;
        }

        @keyframes spinTarget { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }

        /* N√∫t Tr·∫≠n Ph√°p */
        .dharma-btn {
            position: relative;
            background: linear-gradient(135deg, #2a1b3d, #000);
            border: 2px solid #5a3e7a;
            color: #d4af37;
            transition: all 0.3s;
            clip-path: polygon(20% 0%, 80% 0%, 100% 20%, 100% 80%, 80% 100%, 20% 100%, 0% 80%, 0% 20%);
            display: flex; align-items: center; justify-content: center;
        }
        .dharma-btn.hovered {
            transform: scale(1.15);
            border-color: #00ffff;
            color: #00ffff;
            box-shadow: 0 0 30px cyan;
            background: #3a2b4d;
        }
        
        .energy-fill {
            position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0, 255, 255, 0.4);
            transition: height 0.1s linear; mix-blend-mode: screen; pointer-events: none;
        }
        
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100; color: #d4af37;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .winner-card {
            background: rgba(0,0,0,0.8); border: 2px solid gold;
            box-shadow: 0 0 20px gold;
            animation: floatItem 3s ease-in-out infinite;
        }
        @keyframes floatItem { 0%, 100% {transform: translateY(0px);} 50% {transform: translateY(-10px);} }

    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- √ÇM THANH ---
        const playSound = (type) => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const audioCtx = new AudioContext();
                const osc = audioCtx.createOscillator(); 
                const gain = audioCtx.createGain();
                const now = audioCtx.currentTime;
                
                osc.connect(gain); gain.connect(audioCtx.destination);
                
                if(type === 'hover') {
                    osc.frequency.setValueAtTime(600, now);
                    osc.frequency.linearRampToValueAtTime(800, now + 0.1);
                    gain.gain.setValueAtTime(0.05, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.1);
                    osc.start(now); osc.stop(now + 0.1);
                } else if (type === 'select') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(300, now);
                    osc.frequency.linearRampToValueAtTime(600, now + 0.2);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                    osc.start(now); osc.stop(now + 0.5);
                } else if (type === 'win') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(523.25, now);
                    osc.frequency.setValueAtTime(659.25, now+0.1);
                    osc.frequency.setValueAtTime(783.99, now+0.2);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.linearRampToValueAtTime(0, now + 1.0);
                    osc.start(now); osc.stop(now + 1.0);
                }
            } catch(e) { console.warn("Audio error", e); }
        };

        // --- 3D SCENE ---
        const ThreeScene = ({ studentList, isSpinning }) => {
            const containerRef = useRef(null);
            const sceneRef = useRef({ scene: null, camera: null, renderer: null, group: null, particles: [] });

            useEffect(() => {
                if(!containerRef.current) return;
                
                // Init Scene
                const w = window.innerWidth;
                const h = window.innerHeight;
                const scene = new THREE.Scene();
                // Fog for depth
                scene.fog = new THREE.FogExp2(0x000000, 0.08);

                const camera = new THREE.PerspectiveCamera(75, w/h, 0.1, 100);
                camera.position.z = 8;

                const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
                renderer.setSize(w, h);
                containerRef.current.innerHTML = ''; // Clear prev
                containerRef.current.appendChild(renderer.domElement);

                // Particles (Linh Kh√≠)
                const particles = [];
                for(let i=0; i<50; i++) {
                    const geo = new THREE.DodecahedronGeometry(0.15, 0);
                    const mat = new THREE.MeshBasicMaterial({ color: 0x00ffff, wireframe: true, transparent: true, opacity: 0.5 });
                    const mesh = new THREE.Mesh(geo, mat);
                    mesh.position.set((Math.random()-0.5)*15, (Math.random()-0.5)*15, (Math.random()-0.5)*10);
                    mesh.userData = { speed: Math.random()*0.02 + 0.01, yOffset: Math.random()*100 };
                    scene.add(mesh);
                    particles.push(mesh);
                }

                // Name Group
                const group = new THREE.Group();
                scene.add(group);

                sceneRef.current = { scene, camera, renderer, group, particles };

                const animate = () => {
                    requestAnimationFrame(animate);
                    
                    // Update particles
                    particles.forEach(p => {
                        p.position.y += p.userData.speed;
                        p.rotation.x += 0.02;
                        if(p.position.y > 8) p.position.y = -8;
                    });

                    // Update Group Rotation
                    if(group) {
                        group.rotation.y += isSpinning ? 0.3 : 0.003;
                        group.rotation.x = Math.sin(Date.now() * 0.001) * 0.1;
                    }

                    renderer.render(scene, camera);
                };
                animate();

                const handleResize = () => {
                    const newW = window.innerWidth;
                    const newH = window.innerHeight;
                    renderer.setSize(newW, newH);
                    camera.aspect = newW/newH;
                    camera.updateProjectionMatrix();
                };
                window.addEventListener('resize', handleResize);

                return () => window.removeEventListener('resize', handleResize);
            }, []); // Run once on mount

            // Update Text when list changes
            useEffect(() => {
                const { scene, group } = sceneRef.current;
                if(!group) return;

                // Clear old sprites
                while(group.children.length > 0){ 
                    group.remove(group.children[0]); 
                }

                // Create new sprites
                studentList.forEach((name, i) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 512; canvas.height = 128;
                    ctx.font = 'bold 40px "Noto Serif SC"';
                    ctx.fillStyle = '#ffd700';
                    ctx.textAlign = 'center';
                    ctx.shadowColor = '#d63384'; ctx.shadowBlur = 10;
                    ctx.fillText(name, 256, 64);
                    
                    const texture = new THREE.CanvasTexture(canvas);
                    const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: texture, transparent: true }));
                    sprite.scale.set(4, 1, 1);
                    
                    const angle = (i / studentList.length) * Math.PI * 2;
                    const radius = 9;
                    sprite.position.set(Math.cos(angle)*radius, (Math.random()-0.5)*5, Math.sin(angle)*radius);
                    group.add(sprite);
                });

            }, [studentList]);

            // Sync spin speed logic handled in animate loop via prop ref if needed, 
            // but react update works fine for simple boolean toggle
            useEffect(() => {
                 // Trigger visual change on spin
            }, [isSpinning]);

            return <div ref={containerRef} className="absolute inset-0 z-0" />;
        };

        function App() {
            // Data
            const [studentList, setStudentList] = useState([
                "Nguy·ªÖn V≈© Thu An", "Tr·∫ßn Ph√∫c An", "Nguy·ªÖn Ng·ªçc Th·ª•y Anh", "Nguy·ªÖn Vi·ªát Anh", 
                "Ph·∫°m Di·ªáu Anh", "Phan Nh·∫≠t √Çn", "V≈© Y·∫øn Chi", "H√πng C√¥ng Danh", "ƒê√†o Minh D≈©ng", 
                "Nguy·ªÖn L√™ Tr·∫°ch ƒê√¥ng", "Phan Ng·ªçc Khoa", "Nguy·ªÖn L√™ Minh Kh√¥i", "T·∫° Tu·∫•n Ki·ªát", 
                "ƒêinh Phan Thi√™n Kim", "Ng√¥ B·∫£o T√∫ Linh", "Nguy·ªÖn Tr·∫ßn Linh Ng√¢n", "V≈© B·∫£o Ng√¢n", 
                "Nguy·ªÖn Ph√∫c Kh√¥i Nguy√™n", "ƒê·ªó Kh·∫Øc Minh Nh·∫≠t", "L√™ Ng·ªçc An Nhi√™n", "Tr·∫ßn Quang Ninh", 
                "Nguy·ªÖn H√† Minh Ph√°t", "ƒê·ªó Ho√†ng Qu√¢n", "Nguy·ªÖn Th·ªã Minh T√¢m", "Tr·∫ßn Ph·∫°m Qu·ªëc Th·∫Øng", 
                "Phan Ti·∫øn Th·ªãnh", "T√¥ Vƒ©nh Th·ª•y", "Tr·∫ßn L√™ Gia Tu·ªá", "Tr·∫ßn H·ªØu Vi·ªát", "Ph√≠ Ng·ªçc Kh√°nh Vy"
            ]);
            
            // State
            const [appState, setAppState] = useState("INIT"); // INIT, LOADING, READY, ERROR
            const [isSpinning, setIsSpinning] = useState(false);
            const [winners, setWinners] = useState([]);
            const [errorMsg, setErrorMsg] = useState("");
            
            // Input Mode (Camera vs Mouse)
            const [useCamera, setUseCamera] = useState(true);

            // Cursor & Interaction
            const [cursorPos, setCursorPos] = useState({ x: -100, y: -100 });
            const [hoverTarget, setHoverTarget] = useState(null);
            const [hoverProgress, setHoverProgress] = useState(0);
            
            const videoRef = useRef(null);
            const btnRefs = useRef({});
            const logicRef = useRef({ hoverStartTime: 0, isProcessing: false });

            // --- CAMERA SETUP ---
            const startSystem = async (enableCam) => {
                setAppState("LOADING");
                setUseCamera(enableCam);

                try {
                    if (enableCam) {
                        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                        if (videoRef.current) {
                            videoRef.current.srcObject = stream;
                            await videoRef.current.play();
                        }
                        
                        // Setup MediaPipe Hands
                        if (window.Hands) {
                            const hands = new window.Hands({locateFile: (f) => `https://unpkg.com/@mediapipe/hands@0.4.1675469240/${f}`});
                            hands.setOptions({maxNumHands: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
                            hands.onResults(onHandResults);
                            
                            const processVideo = async () => {
                                if (appState === "ERROR") return;
                                if (videoRef.current && videoRef.current.readyState >= 2 && !logicRef.current.isProcessing) {
                                    logicRef.current.isProcessing = true;
                                    await hands.send({image: videoRef.current});
                                    logicRef.current.isProcessing = false;
                                }
                                requestAnimationFrame(processVideo);
                            };
                            processVideo();
                        } else {
                            throw new Error("Kh√¥ng t·∫£i ƒë∆∞·ª£c th∆∞ vi·ªán MediaPipe. Vui l√≤ng ki·ªÉm tra m·∫°ng.");
                        }
                    }
                    setAppState("READY");
                } catch (err) {
                    console.error(err);
                    setErrorMsg(err.message || "Kh√¥ng th·ªÉ truy c·∫≠p Camera. ƒê√£ chuy·ªÉn sang ch·∫ø ƒë·ªô chu·ªôt.");
                    setUseCamera(false); // Fallback to mouse
                    setAppState("READY");
                }
            };

            // --- INPUT HANDLING (HAND OR MOUSE) ---
            const onHandResults = (results) => {
                if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) return;
                const lm = results.multiHandLandmarks[0][8]; // Index tip
                updateCursor((1 - lm.x) * window.innerWidth, lm.y * window.innerHeight);
            };

            const onMouseMove = (e) => {
                if (!useCamera) {
                    updateCursor(e.clientX, e.clientY);
                }
            };

            const updateCursor = (x, y) => {
                setCursorPos({x, y});
                if (appState === "READY" && !isSpinning && winners.length === 0) {
                    checkCollision(x, y);
                }
            };

            // --- COLLISION LOGIC ---
            const checkCollision = (cx, cy) => {
                let hitId = null;
                [1, 2, 3, 4, 5].forEach(num => {
                    const btn = btnRefs.current[num];
                    if (btn) {
                        const rect = btn.getBoundingClientRect();
                        if (cx >= rect.left && cx <= rect.right && cy >= rect.top && cy <= rect.bottom) {
                            hitId = num;
                        }
                    }
                });

                const now = Date.now();
                if (hitId) {
                    if (hitId !== hoverTarget) {
                        setHoverTarget(hitId);
                        logicRef.current.hoverStartTime = now;
                        setHoverProgress(0);
                        playSound('hover');
                    } else {
                        // Hold for 1.5 seconds
                        const elapsed = now - logicRef.current.hoverStartTime;
                        const prog = Math.min((elapsed / 1500) * 100, 100);
                        setHoverProgress(prog);
                        if (prog >= 100 && !isSpinning) {
                            triggerGift(hitId);
                            setHoverTarget(null);
                        }
                    }
                } else {
                    if (hoverTarget !== null) {
                        setHoverTarget(null);
                        setHoverProgress(0);
                    }
                }
            };

            // --- GAME LOGIC ---
            const triggerGift = (count) => {
                if(studentList.length < count) { alert("Kh√¥ng ƒë·ªß ng∆∞·ªùi!"); return; }
                playSound('select');
                setIsSpinning(true);
                
                setTimeout(() => {
                    const pool = [...studentList];
                    const selected = [];
                    for(let i=0; i<count; i++) {
                        const idx = Math.floor(Math.random() * pool.length);
                        selected.push(pool[idx]); pool.splice(idx, 1);
                    }
                    setWinners(selected);
                    setIsSpinning(false);
                    playSound('win');
                }, 3000);
            };

            return (
                <div className="w-full h-full relative" onMouseMove={onMouseMove}>
                    {/* VIDEO FEED (Only visible if using camera) */}
                    {useCamera && <video ref={videoRef} playsInline muted id="input-video"></video>}
                    
                    {/* 3D BACKGROUND */}
                    <ThreeScene studentList={studentList} isSpinning={isSpinning} />

                    {/* CURSOR */}
                    <div className="spirit-cursor" style={{ transform: `translate(${cursorPos.x}px, ${cursorPos.y}px)` }}>
                        <div className="spirit-cursor-core"></div>
                        <div className="spirit-cursor-ring"></div>
                    </div>

                    {/* UI LAYER */}
                    <div className="absolute inset-0 z-50 pointer-events-none flex flex-col items-center justify-center p-4">
                        
                        {/* TOP BAR */}
                        <div className="absolute top-0 w-full p-4 flex justify-between items-start pointer-events-none">
                            <div className="glass-panel px-6 py-2 pointer-events-auto">
                                <h1 className="text-2xl title-font text-yellow-400">Thi√™n C∆° B·∫£ng</h1>
                                <p className="text-xs text-gray-300">Nh√¢n s·ªë: {studentList.length}</p>
                            </div>
                            <div className="text-right">
                                {!useCamera && <span className="bg-blue-900 text-blue-200 px-3 py-1 rounded text-xs border border-blue-500 mr-2">Ch·∫ø ƒê·ªô Chu·ªôt</span>}
                                {useCamera && <span className="bg-green-900 text-green-200 px-3 py-1 rounded text-xs border border-green-500 mr-2">Camera ON</span>}
                            </div>
                        </div>

                        {/* ERROR MSG */}
                        {errorMsg && (
                            <div className="absolute top-20 bg-red-900/80 text-white px-4 py-2 rounded border border-red-500">
                                {errorMsg}
                            </div>
                        )}

                        {/* MAIN GAMEPLAY UI */}
                        {appState === "READY" && !isSpinning && winners.length === 0 && (
                            <div className="flex flex-col items-center animate__animated animate__fadeIn">
                                <div className="mb-12 text-center">
                                    <h2 className="text-3xl text-yellow-100 mb-2 title-font drop-shadow-lg">Ch·ªçn S·ªë L∆∞·ª£ng</h2>
                                    <p className="text-cyan-200 text-sm bg-black/50 px-3 py-1 rounded-full border border-cyan-900">
                                        {useCamera ? "Gi∆° ng√≥n tay v√†o √¥ s·ªë" : "Di chu·ªôt v√†o √¥ s·ªë"} v√† gi·ªØ 1.5 gi√¢y
                                    </p>
                                </div>
                                <div className="flex gap-4 md:gap-8 pointer-events-auto">
                                    {[1, 2, 3, 4, 5].map(num => (
                                        <div 
                                            key={num}
                                            ref={el => btnRefs.current[num] = el}
                                            className={`dharma-btn w-16 h-16 md:w-24 md:h-24 rounded-lg cursor-pointer ${hoverTarget === num ? 'hovered' : ''}`}
                                            onClick={() => triggerGift(num)} // Allow click fallback
                                        >
                                            <span className="text-3xl font-bold z-10">{num}</span>
                                            <div className="energy-fill" style={{ height: hoverTarget === num ? `${hoverProgress}%` : '0%' }}></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* SPINNING ANIMATION */}
                        {isSpinning && (
                            <div className="text-center animate__animated animate__pulse animate__infinite">
                                <div className="text-6xl mb-4">‚òØÔ∏è</div>
                                <div className="text-3xl title-font text-yellow-400">Thi√™n ƒê·ªãa V·∫≠n Chuy·ªÉn...</div>
                            </div>
                        )}

                        {/* WINNERS */}
                        {winners.length > 0 && (
                            <div className="flex flex-col items-center animate__animated animate__zoomIn">
                                <h2 className="text-4xl title-font text-yellow-400 mb-8 drop-shadow-[0_0_10px_red]">ƒê·∫°i C∆° Duy√™n</h2>
                                <div className="flex flex-wrap justify-center gap-6 mb-8">
                                    {winners.map((w, i) => (
                                        <div key={i} className="winner-card px-8 py-6 rounded-lg text-center min-w-[200px]">
                                            <div className="text-4xl mb-2">üéÅ</div>
                                            <div className="text-2xl font-bold text-cyan-300 font-serif">{w}</div>
                                        </div>
                                    ))}
                                </div>
                                <div className="flex gap-4 pointer-events-auto">
                                    <button onClick={() => setWinners([])} className="px-6 py-2 bg-gray-700 text-white rounded hover:bg-gray-600">Gi·ªØ L·∫°i</button>
                                    <button onClick={() => {
                                        setStudentList(prev => prev.filter(s => !winners.includes(s)));
                                        setWinners([]);
                                    }} className="px-6 py-2 bg-red-800 text-white rounded border border-red-500 hover:bg-red-700 shadow-[0_0_15px_red]">X√≥a T√™n & Ti·∫øp T·ª•c</button>
                                </div>
                            </div>
                        )}

                        {/* INITIAL SCREEN */}
                        {appState === "INIT" && (
                            <div className="glass-panel p-8 text-center max-w-md pointer-events-auto">
                                <h1 className="text-4xl title-font text-yellow-500 mb-6">Thi√™n C∆° B·∫£ng</h1>
                                <div className="space-y-4">
                                    <button onClick={() => startSystem(true)} className="w-full py-3 bg-cyan-900 text-cyan-100 border border-cyan-500 rounded hover:bg-cyan-800 font-bold">
                                        <i className="fas fa-camera mr-2"></i> D√πng Camera (AR)
                                    </button>
                                    <button onClick={() => startSystem(false)} className="w-full py-3 bg-gray-800 text-gray-300 border border-gray-600 rounded hover:bg-gray-700 font-bold">
                                        <i className="fas fa-mouse mr-2"></i> D√πng Chu·ªôt (Mouse)
                                    </button>
                                </div>
                            </div>
                        )}

                         {/* LOADING SCREEN */}
                         {appState === "LOADING" && (
                            <div className="loading-overlay">
                                <div className="text-6xl animate-spin mb-4">üí†</div>
                                <div className="text-xl">ƒêang kh·ªüi t·∫°o linh tr·∫≠n...</div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>