<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Student Picker - Fairy Tale Edition</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script crossorigin="anonymous" src="https://unpkg.com/@mediapipe/hands@0.4.1646424915/hands.js"></script>
    
    <!-- Custom Fonts: Elegant & Handwritten -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Dancing+Script:wght@700&family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: #0a0510; 
            font-family: 'Quicksand', sans-serif; 
            color: #fff;
        }
        
        #input-video {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; transform: scaleX(-1); z-index: 0;
            opacity: 0.8;
            filter: contrast(1.1) brightness(1.1) saturate(1.2);
            /* Overlay m√†u m·ªông m∆° */
            mask-image: linear-gradient(to bottom, rgba(0,0,0,1), rgba(0,0,0,0.8)); 
        }

        /* L·ªõp ph·ªß m·ªù ·∫£o (Dreamy Overlay) */
        .fairy-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, transparent 0%, rgba(20, 0, 30, 0.4) 100%);
            box-shadow: inset 0 0 100px rgba(255, 215, 0, 0.1);
            pointer-events: none; z-index: 1;
        }

        #output-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 10; pointer-events: none;
        }

        /* Styles cho UI Ti√™n C·∫£nh */
        .fairy-border {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 223, 128, 0.4); /* Gold border */
            box-shadow: 0 0 20px rgba(255, 223, 128, 0.2), inset 0 0 20px rgba(255, 255, 255, 0.1);
            border-radius: 16px;
        }

        .fairy-text-title {
            font-family: 'Cinzel', serif;
            background: linear-gradient(to right, #fff, #ffd700, #fff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .fairy-script {
            font-family: 'Dancing Script', cursive;
        }

        /* Card Animation */
        .winner-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 240, 245, 0.95));
            border: 2px solid #ffd700;
            color: #4a044e;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3), 0 0 20px rgba(255, 215, 0, 0.6);
            animation: floatUp 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes floatUp {
            from { opacity: 0; transform: translateY(50px) scale(0.8) rotate(-5deg); }
            to { opacity: 1; transform: translateY(0) scale(1) rotate(0deg); }
        }

        /* Progress Circle - Magical Style */
        .progress-ring__circle {
            transition: stroke-dashoffset 0.1s linear;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            filter: drop-shadow(0 0 5px #ffd700);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- UTILS: MAGICAL SOUNDS ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const playSound = (type) => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            
            if (type === 'tick') {
                // Ti·∫øng chu√¥ng gi√≥ nh·∫π
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800 + Math.random() * 200, now);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'lock') {
                // Ti·∫øng t√≠ch t·ª• nƒÉng l∆∞·ª£ng (Magical charge)
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(200, now);
                osc.frequency.linearRampToValueAtTime(600, now + 1.0);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.linearRampToValueAtTime(0.2, now + 1.0);
                gain.gain.linearRampToValueAtTime(0, now + 1.5);
                osc.start(now); osc.stop(now + 1.5);
            } else if (type === 'win') {
                // H·ª£p √¢m chi·∫øn th·∫Øng (Major Chord Arpeggio)
                const notes = [523.25, 659.25, 783.99, 1046.50]; // C Major
                notes.forEach((freq, i) => {
                    const o = audioCtx.createOscillator();
                    const g = audioCtx.createGain();
                    o.type = 'sine';
                    o.connect(g);
                    g.connect(audioCtx.destination);
                    o.frequency.value = freq;
                    const time = now + i * 0.1;
                    g.gain.setValueAtTime(0, time);
                    g.gain.linearRampToValueAtTime(0.1, time + 0.05);
                    g.gain.exponentialRampToValueAtTime(0.001, time + 2.0);
                    o.start(time);
                    o.stop(time + 2.0);
                });
            }
        };

        // --- UTILS: FAIRY DUST PARTICLES ---
        class FairyDustSystem {
            constructor(scene) {
                this.scene = scene;
                this.particles = [];
                // Create a soft glowing circle texture
                const canvas = document.createElement('canvas');
                canvas.width = 32; canvas.height = 32;
                const ctx = canvas.getContext('2d');
                const grad = ctx.createRadialGradient(16,16,0, 16,16,16);
                grad.addColorStop(0, 'rgba(255, 255, 200, 1)');
                grad.addColorStop(0.5, 'rgba(255, 215, 0, 0.5)');
                grad.addColorStop(1, 'rgba(0,0,0,0)');
                ctx.fillStyle = grad;
                ctx.fillRect(0,0,32,32);
                
                const texture = new THREE.CanvasTexture(canvas);
                this.material = new THREE.SpriteMaterial({ 
                    map: texture, 
                    transparent: true,
                    blending: THREE.AdditiveBlending 
                });
            }

            spawn(count = 50, center = new THREE.Vector3(0,0,0)) {
                for(let i=0; i<count; i++) {
                    const sprite = new THREE.Sprite(this.material);
                    // Random position around center
                    const r = 2 + Math.random() * 3;
                    const theta = Math.random() * Math.PI * 2;
                    const phi = Math.random() * Math.PI * 2;
                    
                    sprite.position.set(
                        center.x + r * Math.sin(theta) * Math.cos(phi),
                        center.y + r * Math.sin(theta) * Math.sin(phi),
                        center.z + r * Math.cos(theta) - 5 // Push back a bit
                    );

                    sprite.scale.setScalar(0.1 + Math.random() * 0.2);
                    
                    // Velocity: Float upwards gently
                    sprite.userData.velocity = new THREE.Vector3(
                        (Math.random() - 0.5) * 0.02,
                        Math.random() * 0.05 + 0.01,
                        (Math.random() - 0.5) * 0.02
                    );
                    
                    this.scene.add(sprite);
                    this.particles.push(sprite);
                }
            }

            update() {
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const p = this.particles[i];
                    p.position.add(p.userData.velocity);
                    // Twinkle
                    p.material.opacity = 0.5 + Math.sin(Date.now() * 0.005 + p.id) * 0.5;
                    
                    if (p.position.y > 5 || p.material.opacity < 0.01) {
                        this.scene.remove(p);
                        this.particles.splice(i, 1);
                    }
                }
            }
        }

        // --- UTILS: TEXT SPRITE MAKER ---
        const createTextSprite = (text, color = '#FFD700') => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 512;
            canvas.height = 128;
            
            ctx.font = 'bold 60px "Cinzel"'; // Use Cinzel font
            ctx.fillStyle = color;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // Glow effect
            ctx.shadowColor = 'rgba(255, 255, 255, 0.8)';
            ctx.shadowBlur = 15;
            ctx.fillText(text, 256, 64);
            
            const texture = new THREE.CanvasTexture(canvas);
            const material = new THREE.SpriteMaterial({ map: texture, transparent: true });
            const sprite = new THREE.Sprite(material);
            sprite.scale.set(4, 1, 1); // Aspect ratio fix
            return sprite;
        };

        // --- COMPONENT: WINNER CARD ---
        const WinnerCard = ({ name, isSpinning, index }) => (
            <div className="winner-card relative p-4 md:p-6 mb-4 rounded-xl flex items-center gap-4 transform transition-all hover:scale-105" 
                 style={{ animationDelay: `${index * 0.2}s` }}>
                
                {/* Decorative Icon */}
                <div className="flex-shrink-0 w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center border-2 border-yellow-400">
                    <span className="text-2xl">‚ú®</span>
                </div>

                <div className="flex-1">
                    <div className="text-xs text-purple-800 font-bold uppercase tracking-widest mb-1 font-sans opacity-70">
                        Ng∆∞·ªùi ƒë∆∞·ª£c ch·ªçn #{index + 1}
                    </div>
                    <div className="text-2xl md:text-3xl text-purple-900 font-bold font-serif fairy-text-title" style={{textShadow: 'none', background: 'none', WebkitTextFillColor: '#4a044e'}}>
                        {name}
                    </div>
                </div>

                {/* Sparkles CSS */}
                <div className="absolute -top-2 -right-2 text-yellow-400 text-xl animate-pulse">‚ú¶</div>
                <div className="absolute bottom-2 right-4 text-pink-300 text-sm animate-bounce">‚òÖ</div>
            </div>
        );

        function App() {
            // --- STATE ---
            const [appState, setAppState] = useState("INIT");
            const [fingerCount, setFingerCount] = useState(0);
            const [lockProgress, setLockProgress] = useState(0);
            const [isSpinning, setIsSpinning] = useState(false);
            const [winners, setWinners] = useState([]);
            
            // --- DATA: 30 STUDENTS ---
            const fixedStudents = [
                "Nguy·ªÖn V≈© Thu An", "Tr·∫ßn Ph√∫c An", "Nguy·ªÖn Ng·ªçc Th·ª•y Anh", 
                "Nguy·ªÖn Vi·ªát Anh", "Ph·∫°m Di·ªáu Anh", "Phan Nh·∫≠t √Çn", 
                "V≈© Y·∫øn Chi", "H√πng C√¥ng Danh", "ƒê√†o Minh D≈©ng", 
                "Nguy·ªÖn L√™ Tr·∫°ch ƒê√¥ng", "Phan Ng·ªçc Khoa", "Nguy·ªÖn L√™ Minh Kh√¥i", 
                "T·∫° Tu·∫•n Ki·ªát", "ƒêinh Phan Thi√™n Kim", "Ng√¥ B·∫£o T√∫ Linh", 
                "Nguy·ªÖn Tr·∫ßn Linh Ng√¢n", "V≈© B·∫£o Ng√¢n", "Nguy·ªÖn Ph√∫c Kh√¥i Nguy√™n", 
                "ƒê·ªó Kh·∫Øc Minh Nh·∫≠t", "L√™ Ng·ªçc An Nhi√™n", "Tr·∫ßn Quang Ninh", 
                "Nguy·ªÖn H√† Minh Ph√°t", "ƒê·ªó Ho√†ng Qu√¢n", "Nguy·ªÖn Th·ªã Minh T√¢m", 
                "Tr·∫ßn Ph·∫°m Qu·ªëc Th·∫Øng", "Phan Ti·∫øn Th·ªãnh", "T√¥ Vƒ©nh Th·ª•y", 
                "Tr·∫ßn L√™ Gia Tu·ªá", "Tr·∫ßn H·ªØu Vi·ªát", "Ph√≠ Ng·ªçc Kh√°nh Vy"
            ];
            
            const [studentList, setStudentList] = useState(fixedStudents);
            const [isEditingList, setIsEditingList] = useState(false);
            const [tempListText, setTempListText] = useState(fixedStudents.join("\n"));

            // Refs
            const videoRef = useRef(null);
            const containerRef = useRef(null);
            
            const engine = useRef({
                scene: null, camera: null, renderer: null,
                dust: null,
                nameRing: null, // Group containing all name sprites
                ringRotationSpeed: 0.002,
                lastFingerCount: 0,
                lockStartTime: 0,
                isLocked: false
            });

            // --- THREE.JS INIT ---
            useEffect(() => {
                if(!containerRef.current) return;
                const width = window.innerWidth;
                const height = window.innerHeight;
                
                const scene = new THREE.Scene();
                // Add ambient light for general brightness if we used meshes, but sprites are self-illuminated
                
                const camera = new THREE.PerspectiveCamera(75, width/height, 0.1, 100);
                camera.position.z = 6;
                camera.position.y = 1; // Look slightly down or up

                const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
                renderer.setSize(width, height);
                renderer.domElement.id = "output-canvas";
                containerRef.current.appendChild(renderer.domElement);

                // --- 1. FAIRY DUST ---
                const dust = new FairyDustSystem(scene);
                dust.spawn(100); // Initial spawn

                // --- 2. 3D NAME RING (THE "V√íNG TR√íN" INTERFACE) ---
                const nameRing = new THREE.Group();
                scene.add(nameRing);
                
                // Create sprites for all 30 students arranged in a large circle
                const radius = 8;
                const total = fixedStudents.length;
                
                fixedStudents.forEach((name, i) => {
                    const sprite = createTextSprite(name, '#FFFDD0'); // Cream color
                    const angle = (i / total) * Math.PI * 2;
                    
                    // Arrange in a circle on XZ plane
                    sprite.position.x = Math.cos(angle) * radius;
                    sprite.position.z = Math.sin(angle) * radius - 5; // Offset Z to be around/behind
                    sprite.position.y = Math.sin(angle * 2) * 1; // Wave effect in height
                    
                    nameRing.add(sprite);
                });

                engine.current.scene = scene;
                engine.current.camera = camera;
                engine.current.renderer = renderer;
                engine.current.dust = dust;
                engine.current.nameRing = nameRing;

                const animate = () => {
                    requestAnimationFrame(animate);
                    
                    // Update Dust
                    dust.update();
                    if(Math.random() < 0.1) dust.spawn(1); // Continuous gentle spawn
                    
                    // Rotate Ring
                    if (engine.current.nameRing) {
                        engine.current.nameRing.rotation.y += engine.current.ringRotationSpeed;
                    }

                    renderer.render(scene, camera);
                };
                animate();
            }, []);

            // --- HAND TRACKING & LOGIC ---
            const countFingers = (lm) => {
                let count = 0;
                // Check finger extension (Tip Y < PIP Y)
                if (lm[8].y < lm[6].y) count++;
                if (lm[12].y < lm[10].y) count++;
                if (lm[16].y < lm[14].y) count++;
                if (lm[20].y < lm[18].y) count++;
                // Simple Thumb Check
                if (lm[4].y < lm[2].y - 0.05) count++; 
                return Math.min(count, 5);
            };

            const startSystem = async () => {
                try {
                    setAppState("LOADING");
                    const video = videoRef.current;
                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: false, video: { facingMode: "environment" }
                    });
                    video.srcObject = stream;
                    await video.play();

                    const hands = new window.Hands({locateFile: (file) => 
                        `https://unpkg.com/@mediapipe/hands@0.4.1646424915/${file}`
                    });
                    hands.setOptions({
                        maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6
                    });

                    hands.onResults((results) => {
                        const eng = engine.current;
                        if (isSpinning) return; 

                        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                            const lm = results.multiHandLandmarks[0];
                            const currentCount = countFingers(lm);
                            setFingerCount(currentCount);

                            if (currentCount > 0 && currentCount === eng.lastFingerCount) {
                                if (!eng.lockStartTime) eng.lockStartTime = Date.now();
                                const elapsed = Date.now() - eng.lockStartTime;
                                const progress = Math.min((elapsed / 2000) * 100, 100); // 2s lock for smoother feel
                                setLockProgress(progress);

                                if (progress >= 100 && !eng.isLocked) {
                                    eng.isLocked = true;
                                    playSound('lock');
                                    triggerSpin(currentCount);
                                }
                            } else {
                                eng.lastFingerCount = currentCount;
                                eng.lockStartTime = 0;
                                setLockProgress(0);
                                eng.isLocked = false;
                            }
                        } else {
                            setFingerCount(0);
                            setLockProgress(0);
                            eng.lockStartTime = 0;
                        }
                    });

                    const detectLoop = async () => {
                        if (video.readyState >= 2) await hands.send({image: video});
                        requestAnimationFrame(detectLoop);
                    };
                    detectLoop();
                    setAppState("READY");
                } catch (e) {
                    console.error(e);
                    setAppState("ERROR");
                }
            };

            // --- SPIN LOGIC ---
            const triggerSpin = (count) => {
                const eng = engine.current;
                setIsSpinning(true);
                setWinners([]);
                
                // 1. TƒÉng t·ªëc ƒë·ªô quay c·ªßa v√≤ng tr√≤n 3D
                // Ease in speed
                let speed = 0.002;
                const targetSpeed = 0.5; // Very fast
                
                const accelerate = setInterval(() => {
                    speed = Math.min(speed * 1.2, targetSpeed);
                    eng.ringRotationSpeed = speed;
                    playSound('tick'); // Sound effect
                    
                    // Spawn more fairy dust while spinning
                    eng.dust.spawn(2, new THREE.Vector3(0,0,0));
                }, 100);

                // 2. Stop after random time
                setTimeout(() => {
                    clearInterval(accelerate);
                    // Decelerate
                    const decelerate = setInterval(() => {
                        speed = speed * 0.9;
                        eng.ringRotationSpeed = speed;
                        
                        if (speed < 0.005) {
                            clearInterval(decelerate);
                            eng.ringRotationSpeed = 0.002; // Back to idle
                            finalizeWinners(count);
                        }
                    }, 50);
                }, 3000); // Spin for 3 seconds
            };

            const finalizeWinners = (count) => {
                let available = [...studentList];
                let final = [];
                for(let i=0; i<count; i++) {
                    if(available.length === 0) break;
                    const idx = Math.floor(Math.random() * available.length);
                    final.push(available[idx]);
                    available.splice(idx, 1);
                }
                setWinners(final);
                setIsSpinning(false);
                engine.current.isLocked = false;
                playSound('win');
                
                // Huge Dust Explosion
                engine.current.dust.spawn(200, new THREE.Vector3(0,0,2));
            };

            const saveList = () => {
                const arr = tempListText.split('\n').filter(line => line.trim() !== "");
                if (arr.length > 0) {
                    setStudentList(arr);
                    setIsEditingList(false);
                    // Update 3D Ring
                    // Note: In a full app we would regenerate sprites here, 
                    // but for simplicity we assume list is static mostly or reload required for 3D update
                    alert("ƒê√£ c·∫≠p nh·∫≠t d·ªØ li·ªáu. Vui l√≤ng t·∫£i l·∫°i trang ƒë·ªÉ l√†m m·ªõi V√≤ng Xoay 3D.");
                    window.location.reload();
                }
            };

            // Helpers
            const radius = 60;
            const circumference = 2 * Math.PI * radius;
            const strokeDashoffset = circumference - (lockProgress / 100) * circumference;

            return (
                <div className="w-full h-full relative font-sans">
                    {/* Background Layers */}
                    <video ref={videoRef} playsInline muted id="input-video"></video>
                    <div className="fairy-overlay"></div>
                    <div ref={containerRef} className="absolute inset-0 pointer-events-none z-10"></div>

                    {/* --- UI LAYER --- */}
                    <div className="absolute inset-0 z-50 flex flex-col p-4 pointer-events-none">
                        
                        {/* Header */}
                        <div className="flex justify-between items-start pointer-events-auto">
                            <div className="fairy-border px-6 py-3">
                                <h1 className="fairy-text-title text-2xl md:text-3xl font-bold tracking-wider">
                                    L·ªöP H·ªåC K·ª≤ DI·ªÜU
                                </h1>
                                <div className="text-xs text-yellow-100 font-serif italic mt-1">
                                    Sƒ© s·ªë: {studentList.length} H·ªçc Sinh
                                </div>
                            </div>
                            
                            <button 
                                onClick={() => {setIsEditingList(true); setTempListText(studentList.join("\n"));}}
                                className="bg-white/10 hover:bg-white/20 text-yellow-100 px-4 py-2 rounded-full border border-yellow-200/50 backdrop-blur-md transition-all font-serif text-sm"
                            >
                                üìú Danh S√°ch
                            </button>
                        </div>

                        {/* --- MAIN CENTER --- */}
                        <div className="flex-1 flex flex-col items-center justify-center relative">
                            
                            {/* FINGER COUNT / LOCK INDICATOR */}
                            {appState === "READY" && !isSpinning && winners.length === 0 && (
                                <div className="flex flex-col items-center transition-all duration-500" 
                                     style={{
                                         opacity: fingerCount > 0 ? 1 : 0.6,
                                         transform: fingerCount > 0 ? 'scale(1)' : 'scale(0.9)'
                                     }}>
                                    
                                    {/* Magical Circle */}
                                    <div className="relative w-40 h-40 mb-4">
                                        {/* Glow effect behind */}
                                        <div className="absolute inset-0 bg-yellow-400/20 rounded-full blur-xl animate-pulse"></div>
                                        
                                        <svg className="w-full h-full relative z-10 drop-shadow-[0_0_10px_rgba(255,215,0,0.8)]" viewBox="0 0 140 140">
                                            {/* Track */}
                                            <circle cx="70" cy="70" r={radius} stroke="rgba(255,255,255,0.2)" strokeWidth="4" fill="none"/>
                                            {/* Progress */}
                                            <circle 
                                                className="progress-ring__circle"
                                                stroke="#FFD700" strokeWidth="6" strokeLinecap="round" fill="none"
                                                cx="70" cy="70" r={radius}
                                                style={{ strokeDasharray: circumference, strokeDashoffset }}
                                            />
                                        </svg>
                                        
                                        <div className="absolute inset-0 flex items-center justify-center flex-col">
                                            <span className="text-5xl font-serif text-yellow-100 drop-shadow-md">
                                                {fingerCount}
                                            </span>
                                            <span className="text-[10px] text-white/80 uppercase tracking-widest mt-1">Ng∆∞·ªùi</span>
                                        </div>
                                    </div>
                                    
                                    {fingerCount > 0 ? (
                                        <div className="text-center bg-black/30 backdrop-blur px-6 py-2 rounded-full border border-white/20">
                                            <p className="text-yellow-100 font-serif italic">Gi·ªØ y√™n tay ƒë·ªÉ tri·ªáu h·ªìi...</p>
                                        </div>
                                    ) : (
                                        <div className="text-center opacity-70 animate-bounce">
                                            <p className="text-white text-sm font-serif">‚òùÔ∏è Gi∆° ng√≥n tay ƒë·ªÉ ch·ªçn s·ªë l∆∞·ª£ng</p>
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* --- WINNERS DISPLAY --- */}
                            {(winners.length > 0) && (
                                <div className="w-full max-w-3xl flex flex-col items-center z-50">
                                    <h2 className="text-white text-xl font-serif mb-6 animate__animated animate__fadeInDown drop-shadow-lg">
                                        ‚ú® Ch√∫c M·ª´ng C√°c B·∫°n ‚ú®
                                    </h2>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 w-full px-4">
                                        {winners.map((name, idx) => (
                                            <WinnerCard 
                                                key={idx} 
                                                index={idx} 
                                                name={name} 
                                                isSpinning={isSpinning}
                                            />
                                        ))}
                                    </div>

                                    <button 
                                        onClick={() => {setWinners([]); engine.current.isLocked = false;}}
                                        className="mt-10 px-10 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold rounded-full shadow-[0_0_30px_rgba(236,72,153,0.6)] hover:scale-110 transition-transform pointer-events-auto border-2 border-white/50 font-serif"
                                    >
                                        Ti·∫øp T·ª•c
                                    </button>
                                </div>
                            )}

                            {/* --- SPINNING TEXT (While spinning) --- */}
                            {isSpinning && (
                                <div className="text-center animate-pulse z-50">
                                    <div className="text-4xl md:text-6xl mb-2">‚ú®</div>
                                    <div className="text-2xl text-yellow-100 font-serif fairy-text-title tracking-[0.5em]">
                                        ƒêANG CH·ªåN...
                                    </div>
                                </div>
                            )}

                        </div>
                    </div>

                    {/* --- INIT SCREEN --- */}
                    {appState === "INIT" && (
                        <div className="absolute inset-0 z-[60] bg-black/90 flex items-center justify-center p-4">
                            <div className="fairy-border p-10 max-w-lg w-full text-center relative overflow-hidden bg-gradient-to-b from-purple-900/50 to-black/50">
                                <h1 className="text-4xl md:text-5xl font-serif text-yellow-400 mb-4 drop-shadow-[0_0_15px_rgba(255,215,0,0.6)]">
                                    L·ªõp H·ªçc K·ª≥ Di·ªáu
                                </h1>
                                <p className="text-gray-300 mb-8 font-sans font-light italic text-lg">
                                    "N∆°i ph√©p m√†u g·ªçi t√™n nh·ªØng h·ªçc sinh may m·∫Øn"
                                </p>
                                
                                <div className="grid grid-cols-2 gap-4 mb-8 text-left text-sm text-gray-300">
                                    <div className="bg-white/5 p-3 rounded border border-white/10">
                                        <div className="text-yellow-300 font-bold mb-1">üëÜ B∆∞·ªõc 1</div>
                                        Gi∆° ng√≥n tay (1-5) ƒë·ªÉ ch·ªçn s·ªë l∆∞·ª£ng ng∆∞·ªùi.
                                    </div>
                                    <div className="bg-white/5 p-3 rounded border border-white/10">
                                        <div className="text-yellow-300 font-bold mb-1">‚ú® B∆∞·ªõc 2</div>
                                        Gi·ªØ y√™n tay trong 2 gi√¢y ƒë·ªÉ ph√©p thu·∫≠t b·∫Øt ƒë·∫ßu.
                                    </div>
                                </div>

                                <button onClick={startSystem} className="w-full py-4 bg-gradient-to-r from-yellow-600 to-yellow-400 hover:from-yellow-500 hover:to-yellow-300 text-black font-bold text-lg rounded-xl pointer-events-auto shadow-[0_0_20px_rgba(255,215,0,0.4)] transition-all transform hover:-translate-y-1">
                                    M·ªû C√ÅNH C·ªîNG
                                </button>
                            </div>
                        </div>
                    )}

                    {/* --- LIST EDIT MODAL --- */}
                    {isEditingList && (
                        <div className="absolute inset-0 z-[70] bg-black/80 backdrop-blur-md flex items-center justify-center p-4">
                            <div className="bg-[#1a1025] border border-purple-500 w-full max-w-lg rounded-2xl p-6 pointer-events-auto shadow-2xl">
                                <h3 className="text-yellow-400 font-serif text-xl mb-4 text-center">Cu·ªôn Gi·∫•y Danh S√°ch</h3>
                                <textarea 
                                    className="w-full h-64 bg-black/30 border border-purple-700 rounded-lg p-4 text-purple-100 text-sm focus:border-yellow-400 outline-none resize-none font-mono custom-scrollbar"
                                    value={tempListText}
                                    onChange={(e) => setTempListText(e.target.value)}
                                ></textarea>
                                <div className="flex justify-center gap-4 mt-6">
                                    <button onClick={() => setIsEditingList(false)} className="text-gray-400 hover:text-white px-6 py-2 font-serif">ƒê√≥ng l·∫°i</button>
                                    <button onClick={saveList} className="bg-purple-600 text-white px-8 py-2 rounded-full hover:bg-purple-500 font-serif border border-purple-400 shadow-lg">L∆∞u Thay ƒê·ªïi</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>