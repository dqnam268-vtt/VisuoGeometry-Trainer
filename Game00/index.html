<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Thi√™n C∆° B·∫£ng - ƒê·∫øm Ng∆∞·ª£c 3s</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script crossorigin="anonymous" src="https://unpkg.com/@mediapipe/hands@0.4.1675469240/hands.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Merriweather:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { margin: 0; overflow: hidden; background: #050505; font-family: 'Merriweather', serif; user-select: none; }
        
        #input-video {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; transform: scaleX(-1); z-index: 0;
            opacity: 0.25; mix-blend-mode: hard-light; filter: contrast(1.1) grayscale(0.4);
        }

        /* Theme Tu Ti√™n */
        .glass-panel {
            background: rgba(10, 5, 20, 0.85);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.2), inset 0 0 50px rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 16px;
            backdrop-filter: blur(10px);
        }

        .title-font { font-family: 'Cinzel Decorative', cursive; letter-spacing: 2px; text-shadow: 0 0 10px #d4af37; }

        /* N√∫t ch·ªçn s·ªë l∆∞·ª£ng (Tr·∫≠n Ph√°p) */
        .rune-btn {
            position: relative;
            width: 80px; height: 80px;
            background: rgba(0,0,0,0.5);
            border: 2px solid #444;
            display: flex; justify-content: center; align-items: center;
            font-size: 32px; font-weight: bold; color: #888;
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
        }
        .rune-btn::before {
            content: ''; position: absolute; inset: 0;
            background: radial-gradient(circle, rgba(0,255,255,0.2) 0%, transparent 70%);
            opacity: 0; transition: opacity 0.3s;
        }
        .rune-btn.hovered, .rune-btn:hover {
            transform: scale(1.2);
            border-color: #00ffff; color: #00ffff;
            background: rgba(0, 20, 40, 0.8);
            box-shadow: 0 0 20px cyan;
        }
        .rune-btn.hovered::before, .rune-btn:hover::before { opacity: 1; }

        /* Progress Ring cho Hover */
        .progress-ring {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
        }
        
        /* Con tr·ªè Linh H·ªìn */
        .spirit-cursor {
            position: fixed; pointer-events: none; z-index: 9999;
            transition: transform 0.05s linear;
        }
        .spirit-core {
            width: 20px; height: 20px; background: #00ffff; border-radius: 50%;
            box-shadow: 0 0 15px #00ffff, 0 0 30px #0000ff;
        }

        /* ƒê·∫øm ng∆∞·ª£c */
        .countdown-overlay {
            position: fixed; inset: 0; z-index: 100;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
        }
        .countdown-number {
            font-size: 200px; font-weight: 900; color: #ffd700;
            text-shadow: 0 0 50px #ff0000;
            animation: zoomBeat 0.8s infinite;
        }
        @keyframes zoomBeat { 0% {transform: scale(0.5); opacity: 0;} 50% {transform: scale(1.2); opacity: 1;} 100% {transform: scale(1); opacity: 0;} }

        .winner-card {
            background: rgba(20, 0, 0, 0.9); border: 2px solid gold;
            box-shadow: 0 0 30px gold;
            animation: floatItem 3s ease-in-out infinite;
        }
        @keyframes floatItem { 0%, 100% {transform: translateY(0px);} 50% {transform: translateY(-10px);} }

    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- √ÇM THANH ---
        const playSound = (type) => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const audioCtx = new AudioContext();
                const osc = audioCtx.createOscillator(); 
                const gain = audioCtx.createGain();
                const now = audioCtx.currentTime;
                
                osc.connect(gain); gain.connect(audioCtx.destination);
                
                if(type === 'hover') {
                    osc.frequency.setValueAtTime(400, now);
                    osc.frequency.linearRampToValueAtTime(600, now + 0.1);
                    gain.gain.setValueAtTime(0.05, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.1);
                    osc.start(now); osc.stop(now + 0.1);
                } else if (type === 'countdown') {
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(200, now);
                    osc.frequency.exponentialRampToValueAtTime(100, now + 0.3);
                    gain.gain.setValueAtTime(0.2, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                    osc.start(now); osc.stop(now + 0.3);
                } else if (type === 'win') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(523.25, now);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 2.0);
                    osc.start(now); osc.stop(now + 2.0);
                }
            } catch(e) { console.warn("Audio error", e); }
        };

        // --- 3D SCENE ---
        const ThreeScene = ({ studentList, isSpinning }) => {
            const containerRef = useRef(null);
            const sceneRef = useRef({ scene: null, camera: null, renderer: null, group: null });

            useEffect(() => {
                if(!containerRef.current) return;
                const w = window.innerWidth;
                const h = window.innerHeight;
                const scene = new THREE.Scene();
                scene.fog = new THREE.FogExp2(0x050505, 0.05);

                const camera = new THREE.PerspectiveCamera(75, w/h, 0.1, 100);
                camera.position.z = 9;

                const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
                renderer.setSize(w, h);
                containerRef.current.innerHTML = '';
                containerRef.current.appendChild(renderer.domElement);

                // Particles
                for(let i=0; i<60; i++) {
                    const geo = new THREE.TetrahedronGeometry(0.2);
                    const mat = new THREE.MeshBasicMaterial({ color: 0x00ffff, transparent: true, opacity: 0.4 });
                    const mesh = new THREE.Mesh(geo, mat);
                    mesh.position.set((Math.random()-0.5)*25, (Math.random()-0.5)*25, (Math.random()-0.5)*10);
                    scene.add(mesh);
                }

                const group = new THREE.Group();
                scene.add(group);
                sceneRef.current = { scene, camera, renderer, group };

                const animate = () => {
                    requestAnimationFrame(animate);
                    if(group) {
                        group.rotation.y += isSpinning ? 0.4 : 0.002;
                    }
                    renderer.render(scene, camera);
                };
                animate();

                const handleResize = () => {
                    renderer.setSize(window.innerWidth, window.innerHeight);
                    camera.aspect = window.innerWidth/window.innerHeight;
                    camera.updateProjectionMatrix();
                };
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            useEffect(() => {
                const { group } = sceneRef.current;
                if(!group) return;
                while(group.children.length > 0) group.remove(group.children[0]); 

                studentList.forEach((name, i) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 1024; canvas.height = 256;
                    
                    ctx.font = 'bold 70px "Merriweather", serif';
                    ctx.fillStyle = '#ffd700';
                    ctx.textAlign = 'center';
                    ctx.shadowColor = '#d63384'; ctx.shadowBlur = 15;
                    ctx.fillText(name, 512, 128);
                    
                    const texture = new THREE.CanvasTexture(canvas);
                    const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: texture, transparent: true }));
                    sprite.scale.set(6, 1.5, 1);
                    
                    const angle = (i / studentList.length) * Math.PI * 2;
                    const r = 11;
                    sprite.position.set(Math.cos(angle)*r, (Math.random()-0.5)*8, Math.sin(angle)*r);
                    group.add(sprite);
                });
            }, [studentList]);

            return <div ref={containerRef} className="absolute inset-0 z-0" />;
        };

        function App() {
            // Data
            const [studentList, setStudentList] = useState([
                "Nguy·ªÖn V≈© Thu An", "Tr·∫ßn Ph√∫c An", "Nguy·ªÖn Ng·ªçc Th·ª•y Anh", "Nguy·ªÖn Vi·ªát Anh", 
                "Ph·∫°m Di·ªáu Anh", "Phan Nh·∫≠t √Çn", "V≈© Y·∫øn Chi", "H√πng C√¥ng Danh", "ƒê√†o Minh D≈©ng", 
                "Nguy·ªÖn L√™ Tr·∫°ch ƒê√¥ng", "Phan Ng·ªçc Khoa", "Nguy·ªÖn L√™ Minh Kh√¥i", "T·∫° Tu·∫•n Ki·ªát", 
                "ƒêinh Phan Thi√™n Kim", "Ng√¥ B·∫£o T√∫ Linh", "Nguy·ªÖn Tr·∫ßn Linh Ng√¢n", "V≈© B·∫£o Ng√¢n", 
                "Nguy·ªÖn Ph√∫c Kh√¥i Nguy√™n", "ƒê·ªó Kh·∫Øc Minh Nh·∫≠t", "L√™ Ng·ªçc An Nhi√™n", "Tr·∫ßn Quang Ninh", 
                "Nguy·ªÖn H√† Minh Ph√°t", "ƒê·ªó Ho√†ng Qu√¢n", "Nguy·ªÖn Th·ªã Minh T√¢m", "Tr·∫ßn Ph·∫°m Qu·ªëc Th·∫Øng", 
                "Phan Ti·∫øn Th·ªãnh", "T√¥ Vƒ©nh Th·ª•y", "Tr·∫ßn L√™ Gia Tu·ªá", "Tr·∫ßn H·ªØu Vi·ªát", "Ph√≠ Ng·ªçc Kh√°nh Vy"
            ]);
            
            const [appState, setAppState] = useState("INIT");
            const [isSpinning, setIsSpinning] = useState(false);
            const [winners, setWinners] = useState([]);
            const [useCamera, setUseCamera] = useState(true);

            // Logic State
            const [cursorPos, setCursorPos] = useState({ x: -100, y: -100 });
            const [hoverTarget, setHoverTarget] = useState(null);
            const [countdown, setCountdown] = useState(null); // null, 3, 2, 1

            const videoRef = useRef(null);
            const btnRefs = useRef({});
            const logicRef = useRef({ 
                hoverStartTime: 0, 
                isProcessing: false,
                targetCount: 0 // S·ªë l∆∞·ª£ng mu·ªën ch·ªçn
            });

            // --- CAMERA SETUP ---
            const startSystem = async (enableCam) => {
                setAppState("LOADING");
                setUseCamera(enableCam);

                try {
                    if (enableCam) {
                        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                        if (videoRef.current) {
                            videoRef.current.srcObject = stream;
                            await videoRef.current.play();
                        }
                        
                        if (window.Hands) {
                            const hands = new window.Hands({locateFile: (f) => `https://unpkg.com/@mediapipe/hands@0.4.1675469240/${f}`});
                            hands.setOptions({maxNumHands: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
                            hands.onResults(onHandResults);
                            
                            const processVideo = async () => {
                                if (appState === "ERROR") return;
                                if (videoRef.current && videoRef.current.readyState >= 2 && !logicRef.current.isProcessing) {
                                    logicRef.current.isProcessing = true;
                                    await hands.send({image: videoRef.current});
                                    logicRef.current.isProcessing = false;
                                }
                                requestAnimationFrame(processVideo);
                            };
                            processVideo();
                        }
                    }
                    setAppState("READY");
                } catch (err) {
                    console.error(err);
                    setUseCamera(false);
                    setAppState("READY");
                }
            };

            // --- X·ª¨ L√ù NG√ìN TAY (CURSOR MODE) ---
            const onHandResults = (results) => {
                if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) return;
                
                // L·∫•y ƒë·∫ßu ng√≥n tr·ªè (Landmark 8) l√†m con tr·ªè
                const lm = results.multiHandLandmarks[0][8]; 
                const x = (1 - lm.x) * window.innerWidth;
                const y = lm.y * window.innerHeight;
                
                setCursorPos({x, y});
                if (appState === "READY" && !isSpinning && winners.length === 0 && countdown === null) {
                    checkCollision(x, y);
                }
            };

            const onMouseMove = (e) => {
                if (!useCamera) {
                    setCursorPos({x: e.clientX, y: e.clientY});
                    // Mouse hover logic is handled via CSS/onClick mostly, but we can enable hover trigger too if wanted
                    // For mouse, click is better.
                }
            };

            const checkCollision = (cx, cy) => {
                let hitId = null;
                [1, 2, 3, 4, 5].forEach(num => {
                    const btn = btnRefs.current[num];
                    if (btn) {
                        const rect = btn.getBoundingClientRect();
                        if (cx >= rect.left && cx <= rect.right && cy >= rect.top && cy <= rect.bottom) {
                            hitId = num;
                        }
                    }
                });

                if (hitId) {
                    if (hitId !== hoverTarget) {
                        setHoverTarget(hitId);
                        logicRef.current.hoverStartTime = Date.now();
                        playSound('hover');
                    } else {
                        // Hold 1 second to select
                        if (Date.now() - logicRef.current.hoverStartTime > 1000) {
                            startCountdown(hitId);
                            setHoverTarget(null);
                        }
                    }
                } else {
                    setHoverTarget(null);
                }
            };

            // --- COUNTDOWN & GAME LOGIC ---
            const startCountdown = (count) => {
                if(studentList.length < count) { alert("Kh√¥ng ƒë·ªß ƒë·∫°o h·ªØu!"); return; }
                
                logicRef.current.targetCount = count;
                setCountdown(3);
                playSound('countdown');
                
                let val = 3;
                const timer = setInterval(() => {
                    val--;
                    if(val > 0) {
                        setCountdown(val);
                        playSound('countdown');
                    } else {
                        clearInterval(timer);
                        setCountdown(null);
                        triggerGift(logicRef.current.targetCount);
                    }
                }, 1000);
            };

            const triggerGift = (count) => {
                setIsSpinning(true);
                
                setTimeout(() => {
                    const pool = [...studentList];
                    const selected = [];
                    for(let i=0; i<count; i++) {
                        const idx = Math.floor(Math.random() * pool.length);
                        selected.push(pool[idx]); pool.splice(idx, 1);
                    }
                    setWinners(selected);
                    setIsSpinning(false);
                    playSound('win');
                }, 2000); // 2 gi√¢y quay
            };

            return (
                <div className="w-full h-full relative" onMouseMove={onMouseMove}>
                    {useCamera && <video ref={videoRef} playsInline muted id="input-video"></video>}
                    <ThreeScene studentList={studentList} isSpinning={isSpinning} />

                    {/* CURSOR (Ch·ªâ hi·ªán khi d√πng Camera) */}
                    {useCamera && (
                        <div className="spirit-cursor" style={{ transform: `translate(${cursorPos.x}px, ${cursorPos.y}px)` }}>
                            <div className="spirit-core"></div>
                        </div>
                    )}

                    {/* COUNTDOWN OVERLAY */}
                    {countdown !== null && (
                        <div className="countdown-overlay">
                            <div className="countdown-number">{countdown}</div>
                        </div>
                    )}

                    {/* UI LAYER */}
                    <div className="absolute inset-0 z-50 pointer-events-none flex flex-col items-center justify-center p-4">
                        
                        {/* HEADER */}
                        <div className="absolute top-0 w-full p-4 flex justify-between items-start pointer-events-none">
                            <div className="glass-panel px-6 py-2 pointer-events-auto">
                                <h1 className="text-3xl title-font text-yellow-500">Thi√™n C∆° B·∫£ng</h1>
                                <p className="text-sm text-cyan-200">T·ªïng: {studentList.length} ƒê·∫°o H·ªØu</p>
                            </div>
                        </div>

                        {/* M√ÄN H√åNH CH·ªåN S·ªê (TR·∫¨N PH√ÅP) */}
                        {appState === "READY" && !isSpinning && winners.length === 0 && countdown === null && (
                            <div className="flex flex-col items-center animate__animated animate__fadeInUp">
                                <div className="mb-8 text-center pointer-events-auto">
                                    <h2 className="text-2xl text-yellow-200 mb-2 title-font">Ch·ªçn S·ªë L∆∞·ª£ng ƒê·∫°o H·ªØu</h2>
                                    <p className="text-gray-400 text-sm bg-black/50 px-4 py-1 rounded-full border border-gray-700">
                                        {useCamera ? "Di chuy·ªÉn ƒë·ªëm l·ª≠a v√†o √¥ s·ªë v√† gi·ªØ 1 gi√¢y" : "Nh·∫•n chu·ªôt v√†o √¥ s·ªë"}
                                    </p>
                                </div>
                                <div className="flex gap-6 pointer-events-auto">
                                    {[1, 2, 3, 4, 5].map(num => (
                                        <div 
                                            key={num}
                                            ref={el => btnRefs.current[num] = el}
                                            className={`rune-btn ${hoverTarget === num ? 'hovered' : ''}`}
                                            onClick={() => startCountdown(num)} // Click cho chu·ªôt
                                        >
                                            <span className="z-10">{num}</span>
                                            {/* Visual Progress ring n·∫øu hover */}
                                            {hoverTarget === num && (
                                                <svg className="progress-ring animate-spin" viewBox="0 0 100 100">
                                                    <circle cx="50" cy="50" r="45" stroke="cyan" strokeWidth="4" fill="none" strokeDasharray="283" strokeDashoffset="50" />
                                                </svg>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* HI·ªÜU ·ª®NG QUAY */}
                        {isSpinning && (
                            <div className="text-center animate__animated animate__pulse animate__infinite z-50">
                                <div className="text-8xl mb-4 opacity-80" style={{filter: 'drop-shadow(0 0 20px cyan)'}}>‚òØÔ∏è</div>
                                <div className="text-3xl title-font text-yellow-300">ƒêang V·∫≠n Chuy·ªÉn...</div>
                            </div>
                        )}

                        {/* K·∫æT QU·∫¢ */}
                        {winners.length > 0 && (
                            <div className="flex flex-col items-center animate__animated animate__zoomIn z-50 w-full max-w-5xl">
                                <h2 className="text-5xl title-font text-yellow-400 mb-10 drop-shadow-[0_0_15px_red]">ƒê·∫°i C∆° Duy√™n</h2>
                                <div className="flex flex-wrap justify-center gap-8 mb-10">
                                    {winners.map((w, i) => (
                                        <div key={i} className="winner-card px-8 py-6 rounded-lg text-center min-w-[240px]">
                                            <div className="text-5xl mb-4">üéÅ</div>
                                            <div className="text-3xl font-bold text-cyan-300 font-serif" style={{fontFamily: 'Merriweather'}}>{w}</div>
                                        </div>
                                    ))}
                                </div>
                                <div className="flex gap-6 pointer-events-auto">
                                    <button onClick={() => setWinners([])} className="px-8 py-3 bg-gray-800 border border-gray-500 text-gray-300 rounded hover:bg-gray-700 font-bold uppercase">Gi·ªØ L·∫°i</button>
                                    <button onClick={() => {
                                        setStudentList(prev => prev.filter(s => !winners.includes(s)));
                                        setWinners([]);
                                    }} className="px-8 py-3 bg-red-900 border border-red-500 text-white rounded hover:bg-red-700 shadow-[0_0_20px_red] font-bold uppercase">X√≥a T√™n & Ti·∫øp T·ª•c</button>
                                </div>
                            </div>
                        )}

                        {/* M√ÄN H√åNH CH·ªú BAN ƒê·∫¶U */}
                        {appState === "INIT" && (
                            <div className="glass-panel p-10 text-center max-w-lg pointer-events-auto border-2 border-yellow-600">
                                <h1 className="text-5xl title-font text-yellow-500 mb-2">Thi√™n C∆° B·∫£ng</h1>
                                <p className="text-gray-400 mb-8 italic">"V·∫°n s·ª± t√πy duy√™n, v·∫≠n kh√≠ do tr·ªùi"</p>
                                <div className="space-y-4">
                                    <button onClick={() => startSystem(true)} className="w-full py-4 bg-gradient-to-r from-cyan-900 to-blue-900 text-white border border-cyan-500 rounded hover:scale-105 transition-transform font-bold text-lg shadow-[0_0_15px_cyan]">
                                        <i className="fas fa-hand-sparkles mr-3"></i> B·∫Øt ƒë·∫ßu (Camera)
                                    </button>
                                    <button onClick={() => startSystem(false)} className="w-full py-3 bg-transparent text-gray-400 border border-gray-700 rounded hover:bg-gray-800 font-bold">
                                        <i className="fas fa-mouse mr-3"></i> B·∫Øt ƒë·∫ßu (Chu·ªôt)
                                    </button>
                                </div>
                            </div>
                        )}
                        
                        {/* LOADING */}
                        {appState === "LOADING" && (
                            <div className="absolute inset-0 flex flex-col items-center justify-center bg-black z-[200]">
                                <div className="text-6xl animate-spin mb-6 text-cyan-500">üí†</div>
                                <div className="text-2xl text-yellow-500 font-serif">ƒêang khai m·ªü linh tr·∫≠n...</div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>