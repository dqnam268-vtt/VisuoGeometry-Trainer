<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Gift Picker - Virtual Touch</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    
    <!-- MediaPipe Hands -->
    <script crossorigin="anonymous" src="https://unpkg.com/@mediapipe/hands@0.4.1675469240/hands.js"></script>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Pacifico&family=Quicksand:wght@400;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { margin: 0; overflow: hidden; font-family: 'Quicksand', sans-serif; background: #000; }
        
        #input-video {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; transform: scaleX(-1); z-index: 0;
            opacity: 0.5; mix-blend-mode: overlay;
        }

        #output-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }

        /* Theme Styles */
        .theme-gift {
            background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 99%, #FECFEF 100%);
            background-size: 400% 400%; animation: gradientBG 15s ease infinite;
        }
        @keyframes gradientBG { 0% {background-position:0% 50%} 50% {background-position:100% 50%} 100% {background-position:0% 50%} }

        .ui-glass {
            background: rgba(255, 255, 255, 0.25); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.18);
            color: #5d1a58;
        }

        .title-font { font-family: 'Pacifico', cursive; color: #d63384; text-shadow: 2px 2px 0px #fff; }
        .gift-card { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Virtual Cursor */
        .virtual-cursor {
            position: fixed; pointer-events: none; z-index: 100;
            width: 30px; height: 30px;
            border: 3px solid #00ffea; border-radius: 50%;
            box-shadow: 0 0 15px #00ffea, inset 0 0 10px #00ffea;
            background: rgba(0, 255, 234, 0.2);
            transition: transform 0.1s;
        }
        
        /* Interactive Buttons */
        .ar-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative; overflow: hidden;
        }
        .ar-btn.hovered {
            transform: scale(1.2);
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 20px #ff00ff;
            border-color: #ff00ff;
            color: #d63384;
        }
        .ar-btn .fill-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(255, 0, 255, 0.3);
            transition: height 0.1s linear;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.5); border-radius: 3px; }
    </style>
</head>
<body class="theme-gift">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- THREE.JS HELPERS ---
        class ConfettiParticle {
            constructor(scene) {
                this.scene = scene;
                const geometry = new THREE.PlaneGeometry(0.15, 0.15);
                const colors = [0xff0000, 0x00ff00, 0x0000ff, 0xffff00, 0xff00ff, 0x00ffff];
                const material = new THREE.MeshBasicMaterial({ 
                    color: colors[Math.floor(Math.random() * colors.length)], 
                    side: THREE.DoubleSide 
                });
                this.mesh = new THREE.Mesh(geometry, material);
                this.reset();
                scene.add(this.mesh);
            }
            reset() {
                this.mesh.position.set(0, 0, 0);
                this.velocity = new THREE.Vector3((Math.random()-0.5)*0.5, Math.random()*0.5+0.2, (Math.random()-0.5)*0.5);
                this.rotSpeed = Math.random() * 0.2;
                this.mesh.visible = false;
            }
            explode(pos) {
                this.mesh.position.copy(pos); this.mesh.visible = true;
                this.velocity.set((Math.random()-0.5)*0.5, Math.random()*0.5, (Math.random()-0.5)*0.5);
            }
            update() {
                if(!this.mesh.visible) return;
                this.mesh.position.add(this.velocity);
                this.mesh.rotation.x += this.rotSpeed; this.mesh.rotation.y += this.rotSpeed;
                this.velocity.y -= 0.015;
                if(this.mesh.position.y < -5) this.mesh.visible = false;
            }
        }

        const createGiftSprite = (text) => {
            const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
            canvas.width = 1024; canvas.height = 256;
            ctx.font = 'bold 80px "Quicksand"'; ctx.fillStyle = '#ffffff';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.shadowColor = '#d63384'; ctx.shadowBlur = 20; ctx.lineWidth = 5; ctx.strokeStyle = '#d63384';
            ctx.strokeText("üéÅ " + text, 512, 128); ctx.fillText("üéÅ " + text, 512, 128);
            const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(canvas), transparent: true }));
            sprite.scale.set(8, 2, 1);
            return sprite;
        };

        const playSound = (type) => {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            if(type === 'hover') {
                osc.frequency.setValueAtTime(200, now); osc.frequency.linearRampToValueAtTime(300, now+0.1);
                gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now+0.1);
                osc.start(now); osc.stop(now+0.1);
            } else if (type === 'select') {
                osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(800, now+0.1);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.2);
                osc.start(now); osc.stop(now+0.2);
            } else if (type === 'win') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(523.25, now); osc.frequency.setValueAtTime(659.25, now+0.1);
                osc.frequency.setValueAtTime(783.99, now+0.2); osc.frequency.setValueAtTime(1046.50, now+0.3);
                gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.001, now+1.5);
                osc.start(now); osc.stop(now+1.5);
            }
        };

        function App() {
            // Data & State
            const [studentList, setStudentList] = useState([
                "Nguy·ªÖn V≈© Thu An", "Tr·∫ßn Ph√∫c An", "Nguy·ªÖn Ng·ªçc Th·ª•y Anh", "Nguy·ªÖn Vi·ªát Anh", 
                "Ph·∫°m Di·ªáu Anh", "Phan Nh·∫≠t √Çn", "V≈© Y·∫øn Chi", "H√πng C√¥ng Danh", "ƒê√†o Minh D≈©ng", 
                "Nguy·ªÖn L√™ Tr·∫°ch ƒê√¥ng", "Phan Ng·ªçc Khoa", "Nguy·ªÖn L√™ Minh Kh√¥i", "T·∫° Tu·∫•n Ki·ªát", 
                "ƒêinh Phan Thi√™n Kim", "Ng√¥ B·∫£o T√∫ Linh", "Nguy·ªÖn Tr·∫ßn Linh Ng√¢n", "V≈© B·∫£o Ng√¢n", 
                "Nguy·ªÖn Ph√∫c Kh√¥i Nguy√™n", "ƒê·ªó Kh·∫Øc Minh Nh·∫≠t", "L√™ Ng·ªçc An Nhi√™n", "Tr·∫ßn Quang Ninh", 
                "Nguy·ªÖn H√† Minh Ph√°t", "ƒê·ªó Ho√†ng Qu√¢n", "Nguy·ªÖn Th·ªã Minh T√¢m", "Tr·∫ßn Ph·∫°m Qu·ªëc Th·∫Øng", 
                "Phan Ti·∫øn Th·ªãnh", "T√¥ Vƒ©nh Th·ª•y", "Tr·∫ßn L√™ Gia Tu·ªá", "Tr·∫ßn H·ªØu Vi·ªát", "Ph√≠ Ng·ªçc Kh√°nh Vy"
            ]);
            const [appState, setAppState] = useState("INIT");
            const [isSpinning, setIsSpinning] = useState(false);
            const [winners, setWinners] = useState([]);
            const [isEditing, setIsEditing] = useState(false);
            const [tempList, setTempList] = useState("");
            
            // Cursor State
            const [cursorPos, setCursorPos] = useState({ x: -100, y: -100 });
            const [hoverTarget, setHoverTarget] = useState(null); // ID of button being hovered
            const [hoverProgress, setHoverProgress] = useState(0); // 0-100%

            // Refs
            const videoRef = useRef(null);
            const containerRef = useRef(null);
            const logic = useRef({
                scene: null, camera: null, renderer: null, confetti: [], nameGroup: null,
                isMounted: true, isProcessing: false,
                hoverStartTime: 0
            });
            const btnRefs = useRef({}); // Store button DOM refs

            // 3D Init
            useEffect(() => {
                logic.current.isMounted = true;
                if(!containerRef.current) return;
                const w = window.innerWidth, h = window.innerHeight;
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, w/h, 0.1, 100);
                camera.position.z = 6; camera.position.y = 0.5;
                const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
                renderer.setSize(w, h);
                containerRef.current.appendChild(renderer.domElement);
                
                const confetti = [];
                for(let i=0; i<100; i++) confetti.push(new ConfettiParticle(scene));

                logic.current.scene = scene; logic.current.camera = camera;
                logic.current.renderer = renderer; logic.current.confetti = confetti;

                const animate = () => {
                    if(!logic.current.isMounted) return;
                    requestAnimationFrame(animate);
                    confetti.forEach(p => p.update());
                    if(logic.current.nameGroup) logic.current.nameGroup.rotation.y += isSpinning ? 0.3 : 0.002;
                    renderer.render(scene, camera);
                };
                animate();
                updateNameRing(scene, studentList);
                return () => { logic.current.isMounted = false; }
            }, []);

            const updateNameRing = (scene, list) => {
                if(logic.current.nameGroup) scene.remove(logic.current.nameGroup);
                const group = new THREE.Group();
                list.forEach((name, i) => {
                    const sprite = createGiftSprite(name);
                    const angle = (i / list.length) * Math.PI * 2;
                    const r = 9;
                    sprite.position.set(Math.cos(angle)*r, Math.sin(angle*2)*2, Math.sin(angle)*r - 5);
                    group.add(sprite);
                });
                scene.add(group);
                logic.current.nameGroup = group;
            };

            useEffect(() => { if(logic.current.scene) updateNameRing(logic.current.scene, studentList); }, [studentList]);

            // Camera & Hands
            const startCamera = async () => {
                try {
                    setAppState("LOADING");
                    const stream = await navigator.mediaDevices.getUserMedia({video: {facingMode: "environment"}});
                    if(videoRef.current) { videoRef.current.srcObject = stream; await videoRef.current.play(); }

                    const hands = new window.Hands({locateFile: (f) => `https://unpkg.com/@mediapipe/hands@0.4.1675469240/${f}`});
                    hands.setOptions({maxNumHands: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
                    hands.onResults(onHandResults);

                    const process = async () => {
                        if (!logic.current.isMounted) return;
                        if(videoRef.current && videoRef.current.readyState >= 2 && !logic.current.isProcessing) {
                            logic.current.isProcessing = true;
                            await hands.send({image: videoRef.current});
                            logic.current.isProcessing = false;
                        }
                        requestAnimationFrame(process);
                    };
                    process();
                    setAppState("READY");
                } catch(e) { console.error(e); alert("L·ªói Camera: " + e.message); setAppState("INIT"); }
            };

            // LOGIC CH√çNH: C·∫¨P NH·∫¨T CON TR·ªé & CHECK VA CH·∫†M
            const onHandResults = (results) => {
                if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
                    setCursorPos({x: -100, y: -100}); // Hide cursor
                    return;
                }

                // 1. L·∫•y v·ªã tr√≠ ƒë·∫ßu ng√≥n tr·ªè (Landmark 8)
                const lm = results.multiHandLandmarks[0];
                const indexTip = lm[8];
                
                // 2. Chuy·ªÉn ƒë·ªïi sang t·ªça ƒë·ªô m√†n h√¨nh (L·∫≠t ng∆∞·ª£c tr·ª•c X v√¨ video b·ªã mirror)
                const x = (1 - indexTip.x) * window.innerWidth;
                const y = indexTip.y * window.innerHeight;
                setCursorPos({x, y});

                // 3. Ki·ªÉm tra va ch·∫°m v·ªõi c√°c n√∫t (Ch·ªâ khi ƒëang ·ªü m√†n h√¨nh ch·ªçn)
                if (appState === "READY" && !isSpinning && winners.length === 0) {
                    checkCollision(x, y);
                }
            };

            const checkCollision = (cx, cy) => {
                let hitId = null;
                
                // Duy·ªát qua c√°c n√∫t s·ªë
                [1, 2, 3, 4, 5].forEach(num => {
                    const btn = btnRefs.current[num];
                    if (btn) {
                        const rect = btn.getBoundingClientRect();
                        // Check if cursor is inside button rect
                        if (cx >= rect.left && cx <= rect.right && cy >= rect.top && cy <= rect.bottom) {
                            hitId = num;
                        }
                    }
                });

                // Logic Hover
                const now = Date.now();
                if (hitId) {
                    if (hitId !== hoverTarget) {
                        // M·ªõi b·∫Øt ƒë·∫ßu hover v√†o n√∫t m·ªõi
                        setHoverTarget(hitId);
                        logic.current.hoverStartTime = now;
                        setHoverProgress(0);
                        playSound('hover');
                    } else {
                        // ƒêang hover li√™n t·ª•c
                        const elapsed = now - logic.current.hoverStartTime;
                        const prog = Math.min((elapsed / 1500) * 100, 100); // 1.5s to select
                        setHoverProgress(prog);
                        
                        if (prog >= 100 && !isSpinning) {
                            triggerGift(hitId);
                            setHoverTarget(null); // Reset
                        }
                    }
                } else {
                    // Kh√¥ng hover g√¨ c·∫£
                    if (hoverTarget !== null) {
                        setHoverTarget(null);
                        setHoverProgress(0);
                    }
                }
            };

            const triggerGift = (count) => {
                if(studentList.length < count) { alert("Kh√¥ng ƒë·ªß h·ªçc sinh!"); return; }
                playSound('select');
                setIsSpinning(true);
                
                setTimeout(() => {
                    const pool = [...studentList];
                    const selected = [];
                    for(let i=0; i<count; i++) {
                        const idx = Math.floor(Math.random() * pool.length);
                        selected.push(pool[idx]); pool.splice(idx, 1);
                    }
                    setWinners(selected);
                    setIsSpinning(false);
                    playSound('win');
                    logic.current.confetti.forEach(p => p.explode(new THREE.Vector3((Math.random()-0.5)*5, (Math.random()-0.5)*2, 0)));
                }, 2500);
            };

            const confirmResult = (remove) => {
                if(remove) setStudentList(studentList.filter(s => !winners.includes(s)));
                setWinners([]);
            };

            return (
                <div className="w-full h-full relative text-white select-none">
                    <video ref={videoRef} playsInline muted id="input-video"></video>
                    <div ref={containerRef} className="absolute inset-0 z-0"></div>

                    {/* VIRTUAL CURSOR */}
                    <div className="virtual-cursor" style={{ 
                        transform: `translate(${cursorPos.x - 15}px, ${cursorPos.y - 15}px)`,
                        opacity: cursorPos.x < 0 ? 0 : 1
                    }}></div>

                    {/* TOP BAR */}
                    <div className="absolute top-0 w-full p-4 flex justify-between items-start z-50 pointer-events-none">
                        <div className="ui-glass px-6 py-2 pointer-events-auto">
                            <h1 className="text-2xl title-font text-pink-600">H·ªôp Qu√† May M·∫Øn</h1>
                            <p className="text-xs text-purple-900 font-bold">Danh s√°ch: {studentList.length} b·∫°n</p>
                        </div>
                        <button onClick={()=>{setIsEditing(true); setTempList(studentList.join('\n'))}} className="ui-glass px-4 py-2 pointer-events-auto hover:bg-white/40 text-pink-600 text-xl">
                            <i className="fas fa-edit"></i>
                        </button>
                    </div>

                    {/* CENTER UI */}
                    <div className="absolute inset-0 z-40 flex flex-col items-center justify-center pointer-events-none">
                        
                        {/* SELECTION INTERFACE */}
                        {appState === "READY" && !isSpinning && winners.length === 0 && (
                            <div className="flex flex-col items-center animate__animated animate__fadeIn">
                                <div className="mb-12 text-center pointer-events-auto">
                                    <h2 className="text-4xl font-bold text-white drop-shadow-md mb-2">Ch·ªçn S·ªë L∆∞·ª£ng Qu√†</h2>
                                    <p className="text-lg bg-black/40 px-4 py-1 rounded-full backdrop-blur-sm border border-white/20">
                                        üëâ D√πng ng√≥n tay di chuy·ªÉn con tr·ªè v√†o √¥ s·ªë
                                    </p>
                                </div>

                                <div className="flex gap-4 md:gap-8 pointer-events-auto">
                                    {[1, 2, 3, 4, 5].map(num => (
                                        <div 
                                            key={num}
                                            ref={el => btnRefs.current[num] = el}
                                            className={`ar-btn w-16 h-16 md:w-24 md:h-24 rounded-2xl border-2 border-white/50 bg-white/10 backdrop-blur-md flex items-center justify-center text-3xl md:text-5xl font-bold cursor-pointer
                                                ${hoverTarget === num ? 'hovered' : ''}`}
                                        >
                                            <div className="z-10 relative drop-shadow-md">{num}</div>
                                            {/* Progress Fill */}
                                            <div className="fill-overlay" style={{ height: hoverTarget === num ? `${hoverProgress}%` : '0%' }}></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* SPINNING */}
                        {isSpinning && (
                            <div className="text-center">
                                <div className="text-6xl animate-bounce mb-4">üéÅ</div>
                                <div className="text-4xl font-bold text-white title-font animate-pulse">ƒêang m·ªü qu√†...</div>
                            </div>
                        )}

                        {/* WINNERS */}
                        {winners.length > 0 && (
                            <div className="w-full max-w-4xl px-4 flex flex-col items-center pointer-events-auto animate__animated animate__zoomIn">
                                <h2 className="text-3xl title-font mb-6 text-white drop-shadow-lg">üéâ Ch√∫c M·ª´ng üéâ</h2>
                                <div className="flex flex-wrap justify-center gap-6 mb-8">
                                    {winners.map((w, i) => (
                                        <div key={i} className="ui-glass p-6 gift-card flex flex-col items-center min-w-[200px] bg-white/40">
                                            <div className="text-4xl mb-2">üéÅ</div>
                                            <div className="text-xl font-bold text-purple-900 text-center">{w}</div>
                                        </div>
                                    ))}
                                </div>
                                <div className="flex gap-4">
                                    <button onClick={()=>confirmResult(false)} className="px-6 py-3 rounded-full bg-gray-100 text-gray-700 font-bold shadow-lg">Gi·ªØ l·∫°i t√™n</button>
                                    <button onClick={()=>confirmResult(true)} className="px-8 py-3 rounded-full bg-pink-500 text-white font-bold shadow-lg">X√≥a & Ti·∫øp t·ª•c</button>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* START SCREEN */}
                    {appState === "INIT" && (
                        <div className="absolute inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
                            <div className="ui-glass max-w-md w-full p-10 text-center">
                                <h1 className="text-4xl title-font mb-4">T·∫∑ng Qu√† May M·∫Øn</h1>
                                <p className="mb-8">H·ªá th·ªëng ch·ªçn ng·∫´u nhi√™n b·∫±ng t∆∞∆°ng t√°c AR</p>
                                <button onClick={startCamera} className="w-full py-4 rounded-xl bg-gradient-to-r from-pink-500 to-yellow-500 text-white font-bold text-xl shadow-xl hover:scale-105 transition-transform">
                                    B·∫ÆT ƒê·∫¶U
                                </button>
                            </div>
                        </div>
                    )}
                    
                    {/* EDIT LIST MODAL */}
                    {isEditing && (
                        <div className="absolute inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-md">
                            <div className="ui-glass w-full max-w-2xl p-6 h-[80vh] flex flex-col bg-white/90">
                                <h3 className="text-2xl font-bold text-purple-900 mb-4 text-center">Danh S√°ch</h3>
                                <textarea className="flex-1 border-2 border-pink-200 rounded-xl p-4 text-purple-900 font-mono resize-none focus:outline-none focus:border-pink-500"
                                    value={tempList} onChange={(e) => setTempList(e.target.value)}></textarea>
                                <div className="flex justify-end gap-4 mt-4">
                                    <button onClick={() => setIsEditing(false)} className="px-6 py-2 text-gray-500 font-bold hover:bg-gray-200 rounded-lg">H·ªßy</button>
                                    <button onClick={() => { setStudentList(tempList.split('\n').filter(l => l.trim())); setIsEditing(false); }} className="px-8 py-2 bg-pink-500 text-white font-bold rounded-lg hover:bg-pink-600">L∆∞u L·∫°i</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>