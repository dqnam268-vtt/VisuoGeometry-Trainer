<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Trạm Không Gian Alpha: Nhiệm Vụ Phân Số</title>
    <meta name="description" content="Game VR Giáo dục Toán lớp 6">
    <!-- Nhúng A-Frame (Thư viện VR) -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <!-- Nhúng Component Môi trường để tạo cảnh vũ trụ -->
    <script src="https://unpkg.com/aframe-environment-component@1.3.2/dist/aframe-environment-component.min.js"></script>

    <script>
      // --- LOGIC TRÒ CHƠI (GAME MANAGER) ---
      AFRAME.registerComponent('game-manager', {
        schema: {
          level: {type: 'int', default: 1},
          score: {type: 'int', default: 0}
        },

        init: function () {
          // Khởi tạo các biến
          this.currentLevel = 1;
          this.holdingItem = null; // Vật phẩm đang cầm (ảo)
          this.fusionReady = [];   // Danh sách vật phẩm chờ hợp nhất (cho Level 3)

          // Lấy tham chiếu UI
          this.uiMessage = document.querySelector('#ui-message');
          this.uiSubtext = document.querySelector('#ui-subtext');
          this.uiLevel = document.querySelector('#ui-level');
          
          // Âm thanh (mô phỏng bằng log)
          console.log("Hệ thống khởi động... Chào mừng Kỹ Sư Năng Lượng.");

          // Bắt đầu Level 1
          this.setupLevel(1);
        },

        // Hàm thiết lập màn chơi
        setupLevel: function(level) {
          this.currentLevel = level;
          this.uiLevel.setAttribute('value', `TANG: ${level}/3`);
          
          // Xóa vật thể cũ
          this.clearZone();

          if (level === 1) {
            // LEVEL 1: NHẬN BIẾT
            this.uiMessage.setAttribute('value', 'NHIEM VU: TIM KHOI 1/4');
            this.uiSubtext.setAttribute('value', 'Nap nang luong cho Khoang So Cap');
            
            // Tạo 3 khối: 1/2, 1/4, 1/3
            this.createBlock(-2, 1, -3, 1, 2, "#FF0055"); // 1/2
            this.createBlock(0, 1, -3, 1, 4, "#00FFAA");  // 1/4 (Đúng)
            this.createBlock(2, 1, -3, 1, 3, "#5500FF");  // 1/3
          } 
          else if (level === 2) {
            // LEVEL 2: SO SÁNH
            this.uiMessage.setAttribute('value', 'CAN BANG AP SUAT: > 1/2');
            this.uiSubtext.setAttribute('value', 'Tim khoi nang luong LON HON 1/2');
            
            // Tạo 3 khối: 1/3 (nhỏ hơn), 3/4 (lớn hơn - Đúng), 1/4 (nhỏ hơn)
            this.createBlock(-2, 1, -3, 1, 3, "#FF0055"); // 1/3
            this.createBlock(0, 1, -3, 3, 4, "#00FFAA");  // 3/4 (Mục tiêu)
            this.createBlock(2, 1, -3, 1, 4, "#5500FF");  // 1/4
          }
          else if (level === 3) {
            // LEVEL 3: CỘNG PHÂN SỐ (BOSS)
            this.uiMessage.setAttribute('value', 'LO PHAN UNG: CAN 5/6');
            this.uiSubtext.setAttribute('value', 'Hop nhat 1/2 va 1/3 de tao ra 5/6');

            // Tạo nguyên liệu: 1/2 và 1/3
            this.createBlock(-1.5, 1, -3, 1, 2, "#FF0055"); // 1/2
            this.createBlock(1.5, 1, -3, 1, 3, "#5500FF");  // 1/3
            
            // Tạo máy hợp nhất ở giữa
            this.createFusionMachine(0, 1, -4);
          }
          else {
            // CHIẾN THẮNG
            this.uiMessage.setAttribute('value', 'NHIEM VU HOAN THANH!');
            this.uiSubtext.setAttribute('value', 'Tram Khong Gian Alpha da duoc cuu.');
            this.clearZone();
          }
        },

        // Hàm xử lý khi người chơi chọn một khối
        checkAction: function(selectedBlock) {
          const val = selectedBlock.getAttribute('data-val'); // Giá trị thập phân
          const label = selectedBlock.getAttribute('data-label');

          // LOGIC LEVEL 1
          if (this.currentLevel === 1) {
            if (Math.abs(val - 0.25) < 0.01) {
              this.showFeedback("CHINH XAC! KHOI DONG...", "green");
              setTimeout(() => this.setupLevel(2), 2000);
            } else {
              this.showFeedback("SAI ROI! CAN KHOI 1/4", "red");
            }
          }
          // LOGIC LEVEL 2
          else if (this.currentLevel === 2) {
            if (val > 0.5) {
              this.showFeedback("AP SUAT CAN BANG!", "green");
              setTimeout(() => this.setupLevel(3), 2000);
            } else {
              this.showFeedback("NANG LUONG QUA THAP!", "red");
            }
          }
          // LOGIC LEVEL 3 (HỢP NHẤT)
          else if (this.currentLevel === 3) {
             // Nếu chọn khối 5/6 (sau khi đã hợp nhất thành công)
             if (Math.abs(val - (5/6)) < 0.01) {
                this.showFeedback("KICH HOAT WARP DRIVE!", "gold");
                setTimeout(() => this.setupLevel(4), 3000);
                return;
             }

             // Logic chọn nguyên liệu đưa vào máy
             selectedBlock.setAttribute('visible', 'false'); // Ẩn khối đi
             this.fusionReady.push(val);
             
             this.showFeedback(`Da nap: ${label}. Can them...`, "yellow");

             // Nếu đã nạp đủ 2 khối (1/2 và 1/3)
             if (this.fusionReady.length >= 2) {
               this.showFeedback("DANG HOP NHAT...", "cyan");
               // Gọi máy tạo khối mới
               setTimeout(() => {
                 this.createBlock(0, 1.5, -3, 5, 6, "#FFD700"); // Tạo khối 5/6 vàng rực
                 this.showFeedback("TAO THANH CONG KHOI 5/6! HAY KICH HOAT.", "green");
               }, 1500);
             }
          }
        },

        // Hàm trợ giúp: Tạo khối năng lượng (Hình trụ khuyết)
        createBlock: function(x, y, z, tu, mau, color) {
          const scene = document.querySelector('a-scene');
          const entity = document.createElement('a-entity');
          
          // Tính toán hình dáng (360 độ * giá trị phân số)
          const fractionVal = tu / mau;
          const degrees = fractionVal * 360;

          entity.setAttribute('position', `${x} ${y} ${z}`);
          
          // Hình dáng: Cylinder khuyết
          entity.setAttribute('geometry', `primitive: cylinder; radius: 0.5; height: 0.2; thetaStart: 0; thetaLength: ${degrees}`);
          entity.setAttribute('material', `color: ${color}; opacity: 0.9; metalness: 0.6; roughness: 0.2`);
          
          // Hiệu ứng xoay nhẹ
          entity.setAttribute('animation', `property: rotation; to: 0 360 0; loop: true; dur: 10000; easing: linear`);
          
          // Dữ liệu game
          entity.setAttribute('data-val', fractionVal);
          entity.setAttribute('data-label', `${tu}/${mau}`);
          entity.setAttribute('class', 'interactable');
          
          // Nhãn tên (Floating Text)
          const text = document.createElement('a-text');
          text.setAttribute('value', `${tu}/${mau}`);
          text.setAttribute('align', 'center');
          text.setAttribute('position', '0 0.4 0');
          text.setAttribute('side', 'double');
          text.setAttribute('scale', '2 2 2');
          entity.appendChild(text);

          // Sự kiện click
          entity.addEventListener('click', () => {
             // Hiệu ứng nảy
             entity.setAttribute('animation__click', `property: scale; from: 1.2 1.2 1.2; to: 1 1 1; dur: 200`);
             this.checkAction(entity);
          });
          
          // Sự kiện Hover
          entity.addEventListener('mouseenter', () => {
             entity.setAttribute('scale', '1.1 1.1 1.1');
             entity.setAttribute('material', 'emissive', '#333');
          });
          entity.addEventListener('mouseleave', () => {
             entity.setAttribute('scale', '1 1 1');
             entity.setAttribute('material', 'emissive', '#000');
          });

          scene.appendChild(entity);
        },

        // Tạo máy hợp nhất (Level 3)
        createFusionMachine: function(x, y, z) {
          const scene = document.querySelector('a-scene');
          const machine = document.createElement('a-box');
          machine.setAttribute('position', `${x} ${y-0.5} ${z}`);
          machine.setAttribute('scale', '1 0.1 1');
          machine.setAttribute('color', '#444');
          machine.setAttribute('material', 'wireframe: true');
          
          const label = document.createElement('a-text');
          label.setAttribute('value', 'MAY QUY DONG');
          label.setAttribute('position', '0 0.5 0');
          label.setAttribute('align', 'center');
          machine.appendChild(label);
          
          scene.appendChild(machine);
        },

        // Xóa vật thể màn cũ
        clearZone: function() {
          const els = document.querySelectorAll('.interactable');
          els.forEach(el => el.parentNode.removeChild(el));
          this.fusionReady = [];
        },

        // Hiển thị thông báo
        showFeedback: function(msg, colorName) {
          this.uiSubtext.setAttribute('value', msg);
          this.uiSubtext.setAttribute('color', colorName);
        }
      });
    </script>
  </head>

  <body>
    <a-scene game-manager cursor="rayOrigin: mouse" raycaster="objects: .interactable">
      
      <!-- 1. MÔI TRƯỜNG (TRẠM VŨ TRỤ) -->
      <!-- Sử dụng preset 'tron' để tạo cảm giác sci-fi lưới điện tử -->
      <a-entity environment="preset: tron; skyType: atmosphere; lighting: point; grid: 1x1"></a-entity>

      <!-- 2. UI NGƯỜI CHƠI (HUD) -->
      <a-entity position="0 1.6 -1.5">
        <!-- Bảng thông báo chính -->
        <a-plane color="#000" opacity="0.7" width="2.5" height="1" position="0 0.5 0"></a-plane>
        
        <a-text id="ui-message" value="KHOI DONG..." align="center" position="0 0.7 0.01" width="4" color="#00FFFF"></a-text>
        <a-text id="ui-subtext" value="..." align="center" position="0 0.5 0.01" width="3" color="#CCCCCC"></a-text>
        
        <!-- Cấp độ -->
        <a-text id="ui-level" value="TANG: 1/3" align="right" position="1 0.9 0.01" width="3" color="yellow"></a-text>
      </a-entity>

      <!-- 3. CAMERA & CONTROLLER -->
      <a-entity position="0 1.6 2">
        <a-camera look-controls wasd-controls>
           <!-- Con trỏ ảo (nếu không dùng chuột) -->
           <a-cursor color="cyan" fuse="false"></a-cursor>
        </a-camera>
      </a-entity>

      <!-- 4. ÂM THANH NỀN (Tùy chọn) -->
      <!-- <a-sound src="url_nhac_nen.mp3" autoplay="true" loop="true"></a-sound> -->

    </a-scene>
  </body>
</html>