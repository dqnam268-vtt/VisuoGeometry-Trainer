<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luy·ªán T·∫≠p T·ª± Lu·∫≠n: H√¨nh LƒÉng Tr·ª• ƒê·ª©ng (3D)</title>
    <!-- Three.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #2ecc71;
            --warning: #f1c40f;
            --danger: #e74c3c;
            --light: #f8f9fa;
            --dark: #212529;
            --border-radius: 12px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #eef2f5;
            color: var(--dark);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* HEADER */
        header {
            background: var(--primary);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 { margin: 0; font-size: 22px; }
        
        .progress-container {
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 5px 15px;
            font-size: 14px;
            font-weight: bold;
        }

        /* BODY */
        .main-content {
            padding: 30px;
            flex: 1;
        }

        .question-box {
            background: #fdfdfd;
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
        }

        .q-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--secondary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .q-content {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        /* INPUT AREA */
        .answer-area {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        label { font-weight: 600; font-size: 14px; color: #555; }

        textarea {
            width: 100%;
            height: 150px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius);
            font-family: inherit;
            font-size: 15px;
            resize: vertical;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* FILL IN BLANK STYLES */
        .fill-in-box {
            background: #f0f4f8;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid var(--secondary);
        }
        
        .fill-line {
            margin-bottom: 10px;
            font-size: 16px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .calc-input {
            width: 80px;
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
            color: var(--primary);
        }

        .calc-input:focus {
            outline: none;
            border-color: var(--primary);
            background: #fff;
        }

        .unit {
            font-weight: bold;
            color: #555;
        }

        /* CONTROLS */
        .controls {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 20px;
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.2s;
        }

        .btn-submit { background: var(--success); color: white; }
        .btn-submit:hover { background: #27ae60; transform: translateY(-2px); }

        .btn-next { background: var(--primary); color: white; display: none; }
        .btn-next:hover { background: var(--secondary); }

        .btn-export { background: var(--warning); color: #333; }

        /* FEEDBACK SECTION */
        .feedback-section {
            margin-top: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-left: 5px solid var(--primary);
            border-radius: 8px;
            display: none; /* ·∫®n m·∫∑c ƒë·ªãnh */
            animation: fadeIn 0.5s;
        }

        .feedback-title { font-weight: bold; margin-bottom: 10px; color: #333; }
        
        .model-answer {
            background: #fff;
            padding: 15px;
            border: 1px dashed #ccc;
            border-radius: 8px;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .keyword-check {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .tag {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
        }
        .tag.found { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .tag.missing { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* 3D Container */
        #q-visual {
            width: 100%;
            height: 300px; /* TƒÉng chi·ªÅu cao cho 3D d·ªÖ nh√¨n */
            background: #fafafa;
            border-radius: 8px;
            margin-top: 10px;
            position: relative;
            overflow: hidden;
            border: 1px solid #eee;
        }
        
        .interaction-hint {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            pointer-events: none;
            z-index: 10;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Final Report */
        .report-screen {
            display: none;
            text-align: center;
            padding: 50px;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>üìù Luy·ªán T·∫≠p: H√¨nh LƒÉng Tr·ª• ƒê·ª©ng (3D)</h1>
        <div class="progress-container">
            C√¢u <span id="current-q">1</span> / <span id="total-q">4</span>
        </div>
    </header>

    <!-- M√ÄN H√åNH C√ÇU H·ªéI -->
    <div id="quiz-screen" class="main-content">
        <div class="question-box">
            <div class="q-title">
                <span id="q-icon">ü§î</span>
                <span id="q-title-text">C√¢u h·ªèi 1</span>
            </div>
            <div class="q-content" id="q-text">
                ƒêang t·∫£i c√¢u h·ªèi...
            </div>
            <!-- Ch·ªó ƒë·ªÉ h√¨nh 3D -->
            <div id="q-visual">
                <div class="interaction-hint">üñ±Ô∏è K√©o chu·ªôt ƒë·ªÉ xoay h√¨nh</div>
            </div>
        </div>

        <div class="answer-area" id="input-container">
            <!-- S·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JS: Textarea ho·∫∑c Template -->
        </div>

        <div class="feedback-section" id="feedback-area">
            <div class="feedback-title">üîç ƒê√°nh gi√° t·ª± ƒë·ªông:</div>
            <div class="keyword-check" id="keyword-list"></div>
            
            <div style="margin-top: 15px; font-weight: bold; color: #333;">ƒê√°p √°n tham kh·∫£o:</div>
            <div class="model-answer" id="model-answer"></div>
            
            <p style="font-size: 13px; color: #666; font-style: italic;">
                *H√£y so s√°nh k·∫øt qu·∫£ c·ªßa em v·ªõi ƒë√°p √°n m·∫´u.
            </p>
        </div>

        <div class="controls">
            <button class="btn-submit" id="btn-submit" onclick="submitAnswer()">Ki·ªÉm Tra K·∫øt Qu·∫£</button>
            <button class="btn-next" id="btn-next" onclick="nextQuestion()">C√¢u Ti·∫øp Theo ‚ûú</button>
        </div>
    </div>

    <!-- M√ÄN H√åNH K·∫æT TH√öC -->
    <div id="end-screen" class="report-screen">
        <h2 style="color: var(--success); font-size: 32px;">üéâ Ho√†n Th√†nh!</h2>
        <p>Em ƒë√£ ho√†n th√†nh b√†i luy·ªán t·∫≠p v·ªÅ H√¨nh LƒÉng Tr·ª• ƒê·ª©ng.</p>
        <div style="margin-top: 30px;">
            <button class="btn-export" onclick="downloadReport()">üì• T·∫£i B√°o C√°o K·∫øt Qu·∫£</button>
            <button class="btn-next" style="display:inline-block; background:#6c757d;" onclick="location.reload()">L√†m L·∫°i</button>
        </div>
    </div>
</div>

<script>
    // --- C·∫§U H√åNH THREE.JS ---
    let scene, camera, renderer, controls, animationId;

    function init3D(containerId, geometryType) {
        // 1. D·ªçn d·∫πp scene c≈©
        const container = document.getElementById(containerId);
        // Gi·ªØ l·∫°i c√°i hint text
        const hint = container.querySelector('.interaction-hint');
        container.innerHTML = '';
        if(hint) container.appendChild(hint);

        if (renderer) {
            renderer.dispose();
            cancelAnimationFrame(animationId);
        }

        // 2. Setup c∆° b·∫£n
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xfafafa);

        camera = new THREE.PerspectiveCamera(45, container.offsetWidth / container.offsetHeight, 0.1, 1000);
        camera.position.set(20, 20, 25);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.offsetWidth, container.offsetHeight);
        renderer.shadowMap.enabled = true;
        container.appendChild(renderer.domElement);

        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        // 3. √Ånh s√°ng
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(10, 20, 10);
        dirLight.castShadow = true;
        scene.add(dirLight);

        // 4. Grid v√† Tr·ª•c (Optional - ƒë·ªÉ d·ªÖ nh√¨n h∆°n)
        // const gridHelper = new THREE.GridHelper(50, 50, 0xdddddd, 0xeeeeee);
        // scene.add(gridHelper);

        // 5. T·∫°o h√¨nh kh·ªëi d·ª±a tr√™n Type
        addGeometry(geometryType);

        // 6. Animation Loop
        function animate() {
            animationId = requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        // Resize handler
        window.addEventListener('resize', () => {
            if(!container) return;
            const width = container.offsetWidth;
            const height = container.offsetHeight;
            renderer.setSize(width, height);
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
        });
    }

    function addGeometry(type) {
        let shape = new THREE.Shape();
        let extrudeSettings = { depth: 10, bevelEnabled: false };
        let color = 0x4361ee;
        let geometry;

        if (type === 'tent') {
            // C√¢u 1: L·ªÅu (LƒÉng tr·ª• tam gi√°c c√¢n n·∫±m ngang)
            // ƒê√°y l√† tam gi√°c c√¢n
            shape.moveTo(-3, 0);
            shape.lineTo(3, 0);
            shape.lineTo(0, 4);
            shape.lineTo(-3, 0);
            
            extrudeSettings.depth = 12;
            color = 0xFF9800; // M√†u cam l·ªÅu
            
            geometry = new THREE.ExtrudeGeometry(shape, extrudeSettings);
            // Xoay ƒë·ªÉ n√≥ n·∫±m ngang nh∆∞ c√°i l·ªÅu
            geometry.rotateX(Math.PI / 2); 
            geometry.rotateY(Math.PI / 4); // Xoay nh·∫π cho ƒë·∫πp
            geometry.center(); // CƒÉn gi·ªØa

        } else if (type === 'tri_prism_1') {
            // C√¢u 2: LƒÉng tr·ª• tam gi√°c vu√¥ng (3, 4, 5), cao 10
            // ƒê√°y tam gi√°c vu√¥ng
            shape.moveTo(0, 0);
            shape.lineTo(4, 0);
            shape.lineTo(0, 3);
            shape.lineTo(0, 0);
            
            extrudeSettings.depth = 10;
            color = 0x2ecc71; // Xanh l√°
            
            geometry = new THREE.ExtrudeGeometry(shape, extrudeSettings);
            geometry.center();

        } else if (type === 'quad_prism') {
            // C√¢u 3: M√°ng n∆∞·ªõc (H√¨nh thang vu√¥ng), d√†i 10
            // ƒê√°y h√¨nh thang
            shape.moveTo(0, 0);
            shape.lineTo(4, 0);   // ƒê√°y l·ªõn
            shape.lineTo(3, 3);   // ƒê·ªânh ph·∫£i
            shape.lineTo(0, 3);   // ƒê·ªânh tr√°i (vu√¥ng g√≥c)
            shape.lineTo(0, 0);
            
            extrudeSettings.depth = 10;
            color = 0x039BE5; // Xanh d∆∞∆°ng n∆∞·ªõc
            
            geometry = new THREE.ExtrudeGeometry(shape, extrudeSettings);
            // Xoay n·∫±m ngang ƒë·ªÉ gi·ªëng m√°ng n∆∞·ªõc
            geometry.rotateZ(Math.PI); 
            geometry.rotateX(Math.PI / 2);
            geometry.center();

        } else if (type === 'tri_prism_2') {
            // C√¢u 4: ƒê·ªì ch∆°i g·ªó (Tam gi√°c vu√¥ng 6, 8, 10), cao 5
            shape.moveTo(0, 0);
            shape.lineTo(8, 0);
            shape.lineTo(0, 6);
            shape.lineTo(0, 0);
            
            extrudeSettings.depth = 5;
            color = 0x8D6E63; // M√†u g·ªó
            
            geometry = new THREE.ExtrudeGeometry(shape, extrudeSettings);
            geometry.center();
        }

        // T·∫°o Mesh
        const material = new THREE.MeshPhongMaterial({ 
            color: color, 
            flatShading: false,
            shininess: 50,
            transparent: true,
            opacity: 0.9
        });
        
        // T·∫°o ƒë∆∞·ªùng vi·ªÅn (Edges) ƒë·ªÉ nh√¨n r√µ c·∫°nh
        const edges = new THREE.EdgesGeometry(geometry);
        const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0x000000, linewidth: 2 }));
        
        const mesh = new THREE.Mesh(geometry, material);
        mesh.add(line); // Th√™m vi·ªÅn ƒëen v√†o kh·ªëi
        
        scene.add(mesh);
    }

    // --- D·ªÆ LI·ªÜU C√ÇU H·ªéI ---
    // geometryType t∆∞∆°ng ·ª©ng v·ªõi logic trong addGeometry
    const questions = [
        {
            id: 1,
            type: 'text',
            title: "Nh·∫≠n bi·∫øt LƒÉng Tr·ª• ƒê·ª©ng Tam Gi√°c",
            text: "Quan s√°t m√¥ h√¨nh l·ªÅu tr·∫°i (lƒÉng tr·ª• ƒë·ª©ng tam gi√°c). H√£y m√¥ t·∫£ c√°c ƒë·∫∑c ƒëi·ªÉm h√¨nh h·ªçc c·ªßa n√≥: S·ªë m·∫∑t, s·ªë ƒë·ªânh, s·ªë c·∫°nh v√† h√¨nh d·∫°ng c·ªßa c√°c m·∫∑t b√™n.",
            geometryType: 'tent',
            keywords: ["5 m·∫∑t", "6 ƒë·ªânh", "9 c·∫°nh", "ch·ªØ nh·∫≠t"],
            modelAnswer: "- H√¨nh lƒÉng tr·ª• ƒë·ª©ng tam gi√°c c√≥ 5 m·∫∑t, 6 ƒë·ªânh v√† 9 c·∫°nh.<br>- Hai m·∫∑t ƒë√°y l√† h√¨nh tam gi√°c.<br>- C√°c m·∫∑t b√™n l√† h√¨nh ch·ªØ nh·∫≠t."
        },
        {
            id: 2,
            type: 'template',
            title: "LƒÉng Tr·ª• Tam Gi√°c Vu√¥ng",
            text: "M·ªôt lƒÉng tr·ª• ƒë·ª©ng ƒë√°y tam gi√°c vu√¥ng c√≥ hai c·∫°nh g√≥c vu√¥ng l√† 3cm, 4cm; c·∫°nh huy·ªÅn l√† 5cm. Chi·ªÅu cao lƒÉng tr·ª• l√† 10cm. H√£y ƒëi·ªÅn c√°c s·ªë th√≠ch h·ª£p ƒë·ªÉ t√≠nh di·ªán t√≠ch xung quanh.",
            geometryType: 'tri_prism_1',
            templateHtml: `
                <div class="fill-in-box">
                    <div class="fill-line">
                        1. Chu vi ƒë√°y = <input type="number" class="calc-input" data-idx="0"> cm
                    </div>
                    <div class="fill-line">
                        2. Di·ªán t√≠ch xung quanh = Chu vi ƒë√°y √ó <input type="number" class="calc-input" data-idx="1"> (chi·ªÅu cao)
                    </div>
                    <div class="fill-line">
                        = <input type="number" class="calc-input" data-idx="2"> cm¬≤
                    </div>
                </div>
            `,
            keywords: ["12", "10", "120"], 
            modelAnswer: "Chu vi ƒë√°y = 3 + 4 + 5 = 12 (cm).<br>Di·ªán t√≠ch xung quanh = 12 x 10 = 120 (cm¬≤)."
        },
        {
            id: 3,
            type: 'template',
            title: "LƒÉng Tr·ª• T·ª© Gi√°c (M√°ng N∆∞·ªõc)",
            text: "M·ªôt m√°ng n∆∞·ªõc c√≥ d·∫°ng lƒÉng tr·ª• ƒë·ª©ng t·ª© gi√°c, ƒë√°y l√† h√¨nh thang vu√¥ng. Di·ªán t√≠ch m·∫∑t ƒë√°y h√¨nh thang l√† 0.5 m¬≤. Chi·ªÅu d√†i c·ªßa m√°ng (chi·ªÅu cao lƒÉng tr·ª•) l√† 10m. H√£y t√≠nh th·ªÉ t√≠ch n∆∞·ªõc t·ªëi ƒëa m√°ng ch·ª©a ƒë∆∞·ª£c.",
            geometryType: 'quad_prism',
            templateHtml: `
                <div class="fill-in-box">
                    <div class="fill-line">
                        C√¥ng th·ª©c th·ªÉ t√≠ch V = Di·ªán t√≠ch ƒë√°y √ó Chi·ªÅu cao lƒÉng tr·ª•
                    </div>
                    <div class="fill-line">
                        V = <input type="number" class="calc-input" data-idx="0"> √ó <input type="number" class="calc-input" data-idx="1">
                    </div>
                    <div class="fill-line">
                        K·∫øt qu·∫£ = <input type="number" class="calc-input" data-idx="2"> m¬≥
                    </div>
                </div>
            `,
            keywords: ["0.5", "10", "5"],
            modelAnswer: "Th·ªÉ t√≠ch V = S_ƒë√°y x h = 0.5 x 10 = 5 (m¬≥)."
        },
        {
            id: 4,
            type: 'template',
            title: "Di·ªán T√≠ch To√†n Ph·∫ßn (Kh·ªëi G·ªó)",
            text: "M·ªôt ƒë·ªì ch∆°i b·∫±ng g·ªó d·∫°ng lƒÉng tr·ª• ƒë·ª©ng tam gi√°c. ƒê√°y l√† tam gi√°c vu√¥ng c√≥ hai c·∫°nh g√≥c vu√¥ng l√† 6cm v√† 8cm (c·∫°nh huy·ªÅn 10cm). Chi·ªÅu cao lƒÉng tr·ª• l√† 5cm. H√£y t√≠nh di·ªán t√≠ch to√†n ph·∫ßn.",
            geometryType: 'tri_prism_2',
            templateHtml: `
                <div class="fill-in-box">
                    <div class="fill-line">
                        1. Chu vi ƒë√°y = 6 + 8 + 10 = <input type="number" class="calc-input" data-idx="0"> cm
                    </div>
                    <div class="fill-line">
                        2. S_xq = Chu vi ƒë√°y x 5 = <input type="number" class="calc-input" data-idx="1"> cm¬≤
                    </div>
                    <div class="fill-line">
                        3. Di·ªán t√≠ch 1 m·∫∑t ƒë√°y = (6 x 8) : 2 = <input type="number" class="calc-input" data-idx="2"> cm¬≤
                    </div>
                    <div class="fill-line">
                        4. <strong>S_tp = S_xq + 2.S_ƒë√°y :</strong> <input type="number" class="calc-input" data-idx="3"> cm^2
                    </div>
                </div>
            `,
            keywords: ["s_tp = s_xq + 2.s_ƒë√°y : 168cm^2"], 
            modelAnswer: "Chu vi ƒë√°y = 24cm.<br>S_xq = 24 x 5 = 120cm¬≤.<br>S_ƒë√°y = 24cm¬≤.<br>S_tp = 120 + 2x24 = 168cm¬≤."
        }
    ];

    let currentIdx = 0;
    let userAnswers = []; 

    // --- KH·ªûI T·∫†O ---
    function loadQuestion() {
        const q = questions[currentIdx];
        
        document.getElementById('current-q').innerText = currentIdx + 1;
        document.getElementById('total-q').innerText = questions.length;
        
        document.getElementById('q-title-text').innerText = `C√¢u ${currentIdx + 1}: ${q.title}`;
        document.getElementById('q-text').innerText = q.text;
        
        // Render 3D Scene thay v√¨ SVG
        setTimeout(() => {
            init3D('q-visual', q.geometryType);
        }, 100); // Delay nh·∫π ƒë·ªÉ DOM s·∫µn s√†ng
        
        // Render v√πng nh·∫≠p li·ªáu
        const inputContainer = document.getElementById('input-container');
        inputContainer.innerHTML = ''; 

        if (q.type === 'template') {
            const div = document.createElement('div');
            div.innerHTML = `<label>ƒêi·ªÅn s·ªë th√≠ch h·ª£p v√†o √¥ tr·ªëng:</label>` + q.templateHtml;
            inputContainer.appendChild(div);
        } else {
            inputContainer.innerHTML = `
                <label for="user-answer">B√†i l√†m c·ªßa em:</label>
                <textarea id="user-answer" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi chi ti·∫øt..."></textarea>
            `;
        }

        // Reset UI Feedback
        document.getElementById('feedback-area').style.display = 'none';
        document.getElementById('btn-submit').style.display = 'block';
        document.getElementById('btn-next').style.display = 'none';
    }

    // --- X·ª¨ L√ù N·ªòP B√ÄI ---
    function submitAnswer() {
        const q = questions[currentIdx];
        let userAnswerContent = "";
        let rawCheckString = ""; 

        if (q.type === 'template') {
            const inputs = document.querySelectorAll('.calc-input');
            let allFilled = true;
            let values = [];
            
            inputs.forEach(inp => {
                if(!inp.value) allFilled = false;
                values.push(inp.value.trim());
            });

            if(!allFilled) {
                alert("Em h√£y ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c √¥ tr·ªëng nh√©!");
                return;
            }
            
            if (q.id === 4) {
                userAnswerContent = `Chu vi: ${values[0]}, S_xq: ${values[1]}, S_ƒë√°y: ${values[2]} \n=> S_tp = S_xq + 2.S_ƒë√°y : ${values[3]}cm^2`;
                rawCheckString = `S_tp = S_xq + 2.S_ƒë√°y : ${values[3]}cm^2`; 
            } else {
                userAnswerContent = values.join(" | ");
                rawCheckString = values.join(" ");
            }

        } else {
            const val = document.getElementById('user-answer').value.trim();
            if(!val) {
                alert("Em h√£y nh·∫≠p c√¢u tr·∫£ l·ªùi nh√©!");
                return;
            }
            userAnswerContent = val;
            rawCheckString = val;
        }

        userAnswers[currentIdx] = userAnswerContent;

        // --- LOGIC CH·∫§M ---
        const feedbackArea = document.getElementById('feedback-area');
        const keywordList = document.getElementById('keyword-list');
        const modelAns = document.getElementById('model-answer');

        let htmlTags = "";
        q.keywords.forEach(kw => {
            if(rawCheckString.toLowerCase().includes(kw.toLowerCase())) {
                htmlTags += `<span class="tag found">‚úÖ Ch√≠nh x√°c: "${kw}"</span>`;
            } else {
                htmlTags += `<span class="tag missing">‚ùå Ch∆∞a kh·ªõp: "${kw}"</span>`;
            }
        });

        keywordList.innerHTML = htmlTags;
        modelAns.innerHTML = q.modelAnswer;

        feedbackArea.style.display = 'block';
        document.getElementById('btn-submit').style.display = 'none';
        
        const btnNext = document.getElementById('btn-next');
        btnNext.style.display = 'block';
        if(currentIdx === questions.length - 1) {
            btnNext.innerText = "Xem K·∫øt Qu·∫£ T·ªïng H·ª£p üèÅ";
        } else {
            btnNext.innerText = "C√¢u Ti·∫øp Theo ‚ûú";
        }
    }

    // --- CHUY·ªÇN C√ÇU ---
    function nextQuestion() {
        if(currentIdx < questions.length - 1) {
            currentIdx++;
            loadQuestion();
        } else {
            showEndScreen();
        }
    }

    function showEndScreen() {
        document.getElementById('quiz-screen').style.display = 'none';
        document.getElementById('end-screen').style.display = 'block';
    }

    function downloadReport() {
        let content = "B√ÅO C√ÅO K·∫æT QU·∫¢ LUY·ªÜN T·∫¨P\n";
        content += "M√¥n: H√¨nh h·ªçc 7 - LƒÉng Tr·ª• ƒê·ª©ng\n";
        content += "Th·ªùi gian: " + new Date().toLocaleString() + "\n\n";
        content += "----------------------------------------\n";

        questions.forEach((q, i) => {
            content += `C√ÇU ${i+1}: ${q.title}\n`;
            content += `[B√†i l√†m c·ªßa em]: ${userAnswers[i] || "Ch∆∞a l√†m"}\n`;
            content += "----------------------------------------\n";
        });

        const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `Ket_Qua_Hinh_Hoc_${Date.now()}.txt`;
        link.click();
    }

    // Start App
    window.onload = loadQuestion;

</script>

</body>
</html>